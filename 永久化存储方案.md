# 永久化存储方案

## 1. 概述

本文档详细说明 P-Style 照片风格克隆系统的永久化存储方案，包括数据库设计、配置存储、缓存策略和对象存储方案。根据开发方案和顶层设计文档，系统需要支持开发环境和生产环境的存储需求，确保数据持久化、安全性和可扩展性。当前系统已实现基础的数据库存储（SQLite/MySQL），使用 SQLAlchemy ORM 管理数据模型，所有配置通过环境变量和 .env 文件管理，但缺少数据库迁移工具（Alembic）、Redis 缓存和对象存储方案。本文档将基于现有实现，设计并完善完整的存储架构方案。

## 2. 数据库设计现状

当前系统使用 SQLAlchemy ORM 进行数据库管理，支持 SQLite（开发环境）和 MySQL/PostgreSQL（生产环境）。数据库连接配置通过 `DATABASE_URL` 环境变量管理，默认使用 SQLite（`sqlite:///./photostyle.db`）。系统在应用启动时通过 `Base.metadata.create_all(bind=engine)` 自动创建所有数据表，这种方式在开发环境可行，但生产环境应使用数据库迁移工具（Alembic）进行版本化管理。当前已定义的数据表包括：`users`（用户表，存储用户基本信息、角色、状态）、`auth_tokens`（认证令牌表，统一管理登录会话和验证码）、`analysis_tasks`（分析任务表，存储 Part1/Part2/Part3 的完整分析数据）、`uploads`（上传记录表，存储图片上传信息和相似度）、`subscription_plans`（订阅计划表，定义套餐信息）、`subscriptions`（订阅记录表，关联用户和套餐）、`payments`（支付记录表，记录支付订单信息）。所有表都包含 `created_at` 和 `updated_at` 时间戳字段，支持软删除和审计追踪。

## 3. 数据表详细设计

### 3.1 用户相关表

**users 表**：存储用户核心信息，包括 `id`（主键，自增整数）、`email`（邮箱，唯一索引，用于登录和验证码发送）、`password_hash`（bcrypt 加密的密码哈希）、`display_name`（显示名称，可选）、`avatar_url`（头像 URL，可选）、`role`（角色，默认 "user"，支持 "admin"）、`status`（状态，默认 "active"，支持 "disabled" 禁用账号）、`created_at` 和 `updated_at`（时间戳）。该表通过 `subscriptions` 外键关联到订阅记录，支持一个用户拥有多个订阅（历史记录）。

**auth_tokens 表**：统一管理所有认证令牌和验证码，包括 `id`（主键）、`user_id`（外键，可为 NULL，注册验证码时用户尚未创建）、`email`（邮箱，用于注册验证码查找）、`type`（令牌类型：session/admin_session/email_otp/admin_mfa）、`token`（JWT Token 或 6 位数字验证码，唯一索引）、`expired_at`（过期时间）、`consumed`（是否已消费，用于一次性验证码）、`created_at`（创建时间）。该表支持单点登出（通过标记 Token 为 consumed）和安全审计（记录所有 Token 创建和消费时间）。

### 3.2 任务相关表

**analysis_tasks 表**：存储分析任务的完整数据，包括 `id`（UUID 字符串，主键）、`user_id`（外键，可为 NULL 支持匿名分析）、`source_image_data`（源图 Base64，后续应迁移到对象存储 URL）、`target_image_data`（目标图 Base64，可选）、`gemini_result`（Gemini 原始返回 JSON，用于调试）、`structured_result`（规范映射后的结构化结果 JSON，供前端使用）、`mapping_result`（色彩映射二次结构化结果 JSON）、`part1_summary`（Part1 自然语言摘要文本）、`workflow_draft`（Part1 工作流草案 JSON 字符串）、`workflow_final`（Part2 工作流成品 JSON 字符串）、`workflow_alignment_notes`（草案 vs 执行差异说明文本）、`natural_language_part1`（Part1 全量自然语言报告）、`natural_language_part2`（Part2 全量自然语言报告）、`part2_completed`（Part2 是否完成布尔值）、`feasibility_result`（可行性评估结果 JSON）、`status`（任务状态：pending/part1_completed/completed/failed）、`created_at` 和 `updated_at`（时间戳）。该表是系统的核心数据表，存储了所有分析结果，需要定期备份和归档。

**uploads 表**：存储图片上传记录，包括 `id`（UUID 字符串，主键）、`user_id`（外键，可为 NULL）、`source_image_data`（源图 Base64，后续应迁移到对象存储）、`target_image_data`（目标图 Base64）、`source_image_url`（源图对象存储 URL，预留字段）、`target_image_url`（目标图对象存储 URL，预留字段）、`similarity_score`（相似度分数，DECIMAL(5,2)）、`analysis_task_id`（关联的分析任务 ID，外键）、`status`（状态：uploaded/processing/completed）、`created_at` 和 `updated_at`（时间戳）。该表用于记录上传历史，支持图片去重和相似度分析。

### 3.3 订阅相关表

**subscription_plans 表**：定义订阅套餐模板，包括 `id`（主键）、`name`（套餐名称，如"免费版"、"专业版"）、`description`（套餐描述文本）、`price`（价格，DECIMAL(10,2)）、`period`（计费周期，默认 "monthly"，支持 "yearly"）、`features`（功能特性 JSON，包含 analysis_per_month、generations_per_month 等用量限制）、`is_active`（是否启用布尔值）、`sort_order`（排序顺序整数）、`created_at` 和 `updated_at`（时间戳）。该表由管理员维护，支持动态调整套餐价格和功能。

**subscriptions 表**：记录用户的订阅关系，包括 `id`（主键）、`user_id`（外键，关联用户）、`plan_id`（外键，关联套餐）、`status`（订阅状态：active/cancelled/expired）、`start_at`（订阅开始时间）、`end_at`（订阅结束时间，免费版可为 NULL）、`cancelled_at`（取消时间，可选）、`extra_data`（扩展数据 JSON，存储 auto_renew 等配置）、`created_at` 和 `updated_at`（时间戳）。该表支持一个用户拥有多个历史订阅记录，用于订阅变更追踪。

**payments 表**：记录支付订单信息，包括 `id`（主键）、`order_no`（订单号，唯一索引）、`user_id`（外键，关联用户）、`plan_id`（外键，关联套餐，可选）、`amount`（支付金额，DECIMAL(10,2)）、`currency`（货币类型，默认 "CNY"）、`status`（支付状态：pending/succeeded/failed/refunded）、`channel`（支付渠道，如 "alipay"、"wechat"）、`txn_id`（第三方交易 ID，可选）、`paid_at`（支付完成时间，可选）、`extra_data`（扩展数据 JSON，存储第三方回调数据）、`created_at` 和 `updated_at`（时间戳）。该表用于支付对账和财务审计。

## 4. 数据库索引设计

当前系统已为关键字段创建索引：`users.email`（唯一索引，用于快速登录查询）、`auth_tokens.token`（唯一索引，用于 Token 验证）、`auth_tokens.user_id`（普通索引，用于查询用户的所有 Token）、`analysis_tasks.user_id`（普通索引，用于查询用户的任务列表）、`analysis_tasks.status`（普通索引，用于按状态筛选任务）、`payments.order_no`（唯一索引，用于订单查询）。建议新增索引：`analysis_tasks.created_at`（时间索引，用于按时间排序和归档）、`subscriptions.user_id` 和 `subscriptions.status`（复合索引，用于查询用户的有效订阅）、`uploads.user_id` 和 `uploads.created_at`（复合索引，用于查询用户的上传历史）。所有索引设计遵循"查询优先"原则，避免过度索引导致写入性能下降。

## 5. 数据库迁移方案

当前系统使用 `Base.metadata.create_all(bind=engine)` 在应用启动时自动创建表，这种方式在开发环境可行，但生产环境存在以下问题：无法追踪表结构变更历史、无法回滚到历史版本、无法在多个环境间同步结构变更、无法处理数据迁移（如字段重命名、类型转换）。**推荐方案**：使用 Alembic 作为数据库迁移工具。Alembic 是 SQLAlchemy 官方推荐的迁移工具，支持版本化管理、自动生成迁移脚本、支持升级和降级操作。实施步骤：1) 安装 Alembic（`pip install alembic`），2) 初始化迁移环境（`alembic init alembic`），3) 配置 `alembic.ini` 和 `alembic/env.py` 连接数据库，4) 生成初始迁移（`alembic revision --autogenerate -m "Initial migration"`），5) 应用迁移（`alembic upgrade head`），6) 后续每次模型变更时生成新迁移（`alembic revision --autogenerate -m "Add new field"`）并应用。迁移文件存储在 `server_py/alembic/versions/` 目录，支持版本控制和团队协作。

## 6. 系统配置存储方案

当前系统使用 Pydantic Settings 管理配置，所有配置通过环境变量和 `.env` 文件加载。配置分类包括：**基础配置**（APP_NAME、DEBUG、API_V1_STR）、**数据库配置**（DATABASE_URL，支持 SQLite/MySQL/PostgreSQL）、**安全配置**（SECRET_KEY、ACCESS_TOKEN_EXPIRE_MINUTES、ADMIN_MAX_FAILED_ATTEMPTS、ADMIN_LOCK_MINUTES）、**Gemini API 配置**（GEMINI_API_KEY、GEMINI_MODEL、GEMINI_FLASH_MODEL、GEMINI_TIMEOUT_MS）、**代理配置**（HTTP_PROXY、HTTPS_PROXY，用于 ClashX 代理）、**CORS 配置**（FRONTEND_ORIGINS，生产环境允许的前端域名）、**阿里云邮件服务配置**（ALIYUN_ACCESS_KEY_ID、ALIYUN_ACCESS_KEY_SECRET、ALIYUN_EMAIL_FROM、ALIYUN_EMAIL_TEMPLATE_ID）。所有敏感配置（API Key、Secret Key、数据库密码）必须通过环境变量提供，严禁硬编码在代码中。`.env` 文件应添加到 `.gitignore`，生产环境使用环境变量或密钥管理服务（如 AWS Secrets Manager、阿里云 KMS）存储敏感信息。配置加载使用 `@lru_cache()` 装饰器实现单例模式，避免重复加载。

## 7. 缓存设计方案

当前系统仅实现了 Gemini API 的 `cachedContent` 机制（内存缓存），用于缓存固定 Prompt 模板，减少 Token 消耗。**缺失的缓存方案**：Redis 缓存层。Redis 缓存用于提升系统性能和降低数据库压力，主要应用场景包括：1) **用户会话缓存**（缓存用户信息和订阅状态，TTL 5 分钟，减少数据库查询）、2) **任务结果缓存**（缓存已完成的分析任务结果，TTL 24 小时，支持快速查看历史结果）、3) **验证码缓存**（缓存邮箱验证码，TTL 10 分钟，支持快速验证）、4) **用量统计缓存**（缓存用户当月用量数据，TTL 1 小时，减少聚合查询）、5) **订阅计划缓存**（缓存订阅套餐列表，TTL 1 小时，减少数据库查询）、6) **API 限流缓存**（记录用户请求频率，TTL 60 秒，实现接口限流）。Redis 配置通过环境变量管理：`REDIS_HOST`（Redis 服务器地址，默认 localhost）、`REDIS_PORT`（端口，默认 6379）、`REDIS_PASSWORD`（密码，可选）、`REDIS_DB`（数据库编号，默认 0）。开发环境可使用 Docker 运行 Redis（`docker run -d -p 6379:6379 redis:alpine`），生产环境使用云 Redis 服务（如阿里云 Redis、AWS ElastiCache）。

## 8. 对象存储方案

当前系统将图片以 Base64 格式存储在数据库的 `Text` 字段中，这种方式存在以下问题：数据库体积快速增长、查询性能下降、无法直接通过 URL 访问图片、不支持 CDN 加速、备份和恢复成本高。**推荐方案**：使用对象存储服务（OSS/S3）存储图片，数据库仅存储对象存储 URL。对象存储选择：**开发环境**可使用本地文件系统（`file:///path/to/storage`）或 MinIO（S3 兼容的对象存储，`docker run -d -p 9000:9000 -p 9001:9001 minio/minio server /data --console-address ":9001"`），**生产环境**使用云对象存储服务（阿里云 OSS、AWS S3、腾讯云 COS）。存储结构设计：`uploads/{user_id}/{task_id}/source.jpg`（源图）、`uploads/{user_id}/{task_id}/target.jpg`（目标图）、`results/{task_id}/preview.jpg`（风格模拟预览图）、`avatars/{user_id}/avatar.jpg`（用户头像）。图片上传流程：1) 前端上传图片到后端，2) 后端验证图片格式和大小，3) 生成唯一文件名（UUID），4) 上传到对象存储，5) 获取对象存储 URL，6) 将 URL 保存到数据库，7) 返回 URL 给前端。图片访问：通过对象存储的公开 URL 或签名 URL（带过期时间）访问，支持 CDN 加速和缓存策略。

## 9. 数据备份与恢复方案

数据库备份策略：**开发环境**：SQLite 数据库文件（`photostyle.db`）应定期复制到备份目录，建议每日备份一次，保留最近 7 天的备份。**生产环境**：MySQL/PostgreSQL 使用定时任务（cron）执行 `mysqldump` 或 `pg_dump`，每日全量备份一次，保留最近 30 天的备份，每周备份归档到对象存储。备份文件命名规则：`photostyle_backup_YYYYMMDD_HHMMSS.sql`。对象存储备份：对象存储服务通常提供自动备份和版本控制功能，无需额外备份。数据恢复流程：1) 停止应用服务，2) 恢复数据库备份（`mysql < backup.sql` 或 `psql < backup.sql`），3) 验证数据完整性，4) 重启应用服务。灾难恢复：生产环境应配置主从复制（MySQL Master-Slave 或 PostgreSQL Streaming Replication），主库故障时自动切换到从库，RTO（恢复时间目标）< 5 分钟，RPO（恢复点目标）< 1 分钟。

## 10. 数据归档与清理方案

数据生命周期管理：**分析任务数据**：已完成的任务数据保留 1 年，超过 1 年的任务数据归档到冷存储（对象存储的归档存储类型），数据库仅保留任务元数据（ID、状态、创建时间）。**上传记录数据**：上传记录保留 6 个月，超过 6 个月的记录删除（图片已迁移到对象存储）。**认证令牌数据**：已过期的 Token 和验证码保留 30 天用于审计，超过 30 天的记录删除。**支付记录数据**：支付记录永久保留，用于财务审计和税务申报。**用户数据**：用户账号数据永久保留，即使用户注销账号也保留基础信息（邮箱、注册时间）用于审计，仅标记为 `status=disabled`。清理任务：使用定时任务（cron 或 Celery Beat）每日执行数据清理，删除过期数据和归档历史数据。归档策略：历史数据归档到对象存储的归档存储类型（如阿里云 OSS 归档存储、AWS S3 Glacier），成本降低 80% 以上，需要时可通过 API 解冻（解冻时间 1-5 分钟）。

## 11. 存储容量预估

数据库容量预估：**用户表**：假设 10 万用户，每条记录约 500 字节，总计约 50 MB。**分析任务表**：假设 100 万任务，每条记录平均 50 KB（包含 JSON 数据），总计约 50 GB。**上传记录表**：假设 200 万上传记录，每条记录约 1 KB，总计约 2 GB。**订阅和支付表**：假设 50 万订阅记录和 100 万支付记录，总计约 1 GB。**认证令牌表**：假设 500 万 Token 记录（包含历史记录），每条记录约 200 字节，总计约 1 GB。**数据库总容量**：约 54 GB（不含索引）。对象存储容量预估：**源图和目标图**：假设平均每张图片 2 MB，100 万任务 × 2 张图 = 200 万张图，总计约 4 TB。**风格模拟预览图**：假设每张预览图 500 KB，100 万任务，总计约 500 GB。**用户头像**：假设 10 万用户，每张头像 100 KB，总计约 10 GB。**对象存储总容量**：约 4.5 TB。存储成本优化：使用对象存储的智能分层（热数据标准存储、温数据低频访问存储、冷数据归档存储），可降低 60% 以上存储成本。

## 12. 实施计划

**第一阶段（立即实施）**：1) 安装 Alembic 并初始化迁移环境，2) 生成初始迁移脚本，3) 配置 Redis 连接（开发环境使用 Docker），4) 实现 Redis 缓存服务（用户会话缓存、验证码缓存），5) 更新 `.env.example` 文件，添加 Redis 配置项。**第二阶段（短期优化）**：1) 实现对象存储服务（开发环境使用本地文件系统或 MinIO），2) 修改上传接口，将图片上传到对象存储，3) 修改分析任务表，将 Base64 字段迁移为 URL 字段，4) 实现数据归档任务（定时清理过期数据），5) 添加数据库备份脚本。**第三阶段（生产环境）**：1) 配置生产环境 MySQL/PostgreSQL 主从复制，2) 配置云对象存储（阿里云 OSS 或 AWS S3），3) 配置云 Redis 服务，4) 配置自动备份任务（数据库和对象存储），5) 配置监控告警（存储容量、备份状态）。所有实施步骤都应遵循"先开发环境验证，后生产环境部署"的原则，确保数据安全。

## 13. 安全与合规

**数据加密**：数据库连接使用 TLS/SSL 加密（生产环境必须），敏感字段（如密码哈希）在应用层加密存储，对象存储支持服务端加密（SSE）。**访问控制**：数据库使用最小权限原则，应用数据库用户仅拥有必要的 CRUD 权限，对象存储使用 IAM 策略控制访问权限，Redis 使用密码认证。**数据脱敏**：日志中不记录敏感信息（密码、API Key、完整 Token），数据库备份文件加密存储，生产环境备份文件不存储在开发机器。**合规要求**：用户数据遵循 GDPR 和《个人信息保护法》，支持用户数据导出和删除（"被遗忘权"），支付数据遵循 PCI DSS 标准（如涉及信用卡支付），审计日志保留 1 年以上用于合规审计。**密钥管理**：所有密钥（数据库密码、API Key、对象存储密钥）存储在环境变量或密钥管理服务中，严禁硬编码，定期轮换密钥（建议每 90 天），使用密钥管理服务（如 AWS Secrets Manager、阿里云 KMS）实现密钥的集中管理和审计。

