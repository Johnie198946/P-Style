# 后端迭代说明（2025-11-10）

## 1. 迭代背景
- 用户确认按照“最小改动”原则继续开发，重点解决：
  - Gemini 原始输出缺乏统一结构导致前端解析不稳定。
  - 缺少正式的上传记录与任务查询接口。
  - 需要在顶层设计中反映最新实现状态。

## 2. 主要改动
- **结构化结果映射**
  - 新增 `server/src/services/analysisFormatter.js`，将 Gemini 输出转换为 `review/composition/lighting/color/workflow/execution/meta` 统一对象。
  - `analyzeService` 在 Part1/Part2/Combined 三种模式下均回传 `analysis`（原始）与 `structuredAnalysis`（规范化），并在入库前保存 `structured_result`。
  - 当构图七段存在缺失时，统一写入日志 `warn`，并在 `meta.notes` 添备注记。
- **数据库与任务存储**
  - `analysis_tasks` 表新增 `structured_result` JSON 列，现有列类型统一为 JSON（与代码一致）。
  - 新建 `uploads` 表，用于保存上传记录、相似度与任务关联。
  - `taskService` 读写逻辑同步更新，支持 JSON 字段回读解析。
- **API 扩展**
  - 新增 `POST /api/photos/upload`，用于上传源/目标图与返回粗粒度相似度。
  - `GET /api/analyze/:taskId` 现可直接返回规范化结果，若旧任务缺少结构化数据会实时补齐。
  - `顶层设计文档.md` 更新至最新状态，描述新的模块、数据表与 API。
- **日志策略**
  - 结构化失败时仅输出缺失段落信息，避免记录图片数据。
  - 阶段性分析仍通过 `logger.info/ warn` 记录任务状态，便于排查挂起问题。

## 3. 影响范围
- 后端服务层（`analyzeService`、`analysisFormatter`、`uploadService`）。
- 路由层（`analyzeRoutes`、`uploadRoutes`）。
- 数据访问层（`connection.js`、`taskService.js`）。
- 前端暂未改动，但调用 `/api/analyze/*` 时可直接使用 `structuredAnalysis` 字段，无须重新映射。

## 4. 数据库变更
```sql
ALTER TABLE analysis_tasks ADD COLUMN structured_result JSON AFTER gemini_result;
CREATE TABLE IF NOT EXISTS uploads (...);
```
> 已在 `initDatabase` 中加入向后兼容处理（重复执行将捕获并忽略 `ER_DUP_FIELDNAME`）。

## 5. 自测记录
- 语法检查
  - `node --check server/src/services/analysisFormatter.js`
  - `node --check server/src/services/analyzeService.js`
  - `node --check server/src/routes/uploadRoutes.js`
  - `node --check server/src/routes/analyzeRoutes.js`
- npm 脚本
  - `cd server && npm run lint`（node --check src/index.js）
- 预期下一步：待前端接入 `/api/photos/upload`、`structuredAnalysis` 字段后，再进行端到端联调。

## 6. 待办 / 风险
- 上传接口当前使用“文件大小差值”估算相似度，后续需按规划接入 `image-hash` 或其他特征算法。
- 历史任务列表 `/api/analyze/history` 尚未实现，仍列入路标。
- 需要补充自动化测试（单元 / 集成）以覆盖结构化映射与数据库持久化逻辑。




