# Prompt 模版关键问题分析

## 一、直方图数据格式分析

### 1.1 从文档中提取的结构

根据 `Part1新Prompt模版迁移方案.md` 第 108-113 行：

```json
{
  "module_1_critique": {
    "color_depth_analysis": {
      "text": "长文本：色彩科学分析",
      "simulated_histogram_data": {
        "description": "直方图特征描述",
        "data_points": [10, 15, 20, ... 255个整数]  // 0-255亮度分布
      }
    }
  }
}
```

### 1.2 关键问题

**⚠️ 文档中只显示了一个 `simulated_histogram_data`，没有明确说明是否包含 `reference` 和 `user` 两个字段。**

**可能的情况**：

#### 情况A：只有一个直方图（参考图）
```json
{
  "color_depth_analysis": {
    "text": "...",
    "simulated_histogram_data": {
      "description": "中间低两头高",
      "data_points": [10, 15, 20, ...]
    }
  }
}
```

#### 情况B：包含两个直方图（参考图和用户图）
```json
{
  "color_depth_analysis": {
    "text": "...",
    "simulated_histogram_data": {
      "reference": {
        "description": "中间低两头高",
        "data_points": [10, 15, 20, ...]
      },
      "user": {
        "description": "暗部缺失，高光溢出",
        "data_points": [5, 8, 12, ...]
      }
    }
  }
}
```

#### 情况C：在 `color_depth_analysis` 中分别有两个字段
```json
{
  "color_depth_analysis": {
    "text": "...",
    "reference_histogram": {
      "description": "...",
      "data_points": [...]
    },
    "user_histogram": {
      "description": "...",
      "data_points": [...]
    }
  }
}
```

### 1.3 需要确认

**请查看完整的 Prompt 模版代码示例**，确认：
- [ ] `simulated_histogram_data` 的结构是什么？
- [ ] 是否同时包含参考图和用户图的直方图数据？
- [ ] 如果只有一张图，是哪张图（参考图还是用户图）？

---

## 二、范围字符串格式分析

### 2.1 从文档中提取的格式

根据 `Part1新Prompt模版迁移方案.md` 第 149-155 行：

```json
{
  "module_3_lighting_params": {
    "exposure_control": {
      "exposure": "范围描述 (如: +0.2 ~ +0.5)",
      "contrast": "范围描述",
      "highlights": "范围描述",
      "shadows": "范围描述",
      "whites": "范围描述",
      "blacks": "范围描述"
    }
  }
}
```

### 2.2 可能的情况（根据你的说明）

根据你的说明："有可能是单个值"，可能的情况包括：

1. **范围格式**：`"+0.2 ~ +0.5"` 或 `"-10 ~ +5"`
2. **单个值**：`"+0.3"` 或 `"-15"` ⭐ **你提到的**
3. **描述格式**：`"略微增加曝光约 +0.3EV"` 或 `"微调"`
4. **混合格式**：`"+0.2 ~ +0.5 (建议 +0.35)"`

### 2.3 解析策略（需要支持多种格式）

```python
def _parse_range_string(self, range_str: str) -> Dict[str, str]:
    """
    解析范围字符串，支持多种格式
    
    支持的格式：
    1. 范围："+0.2 ~ +0.5" → range: "+0.35", note: "+0.2 ~ +0.5"
    2. 单个值："+0.3" → range: "+0.30", note: ""
    3. 描述："略微增加曝光约 +0.3EV" → range: "+0.30", note: "略微增加曝光约 +0.3EV"
    4. 模糊描述："微调" → range: "+0", note: "微调"
    """
    if not range_str:
        return {"range": "+0", "note": ""}
    
    import re
    
    # 1. 尝试提取范围（如 "+0.2 ~ +0.5"）
    range_match = re.search(r'([+-]?\d+\.?\d*)\s*~\s*([+-]?\d+\.?\d*)', range_str)
    if range_match:
        val1 = float(range_match.group(1))
        val2 = float(range_match.group(2))
        avg = (val1 + val2) / 2
        return {
            "range": f"{avg:+.2f}" if avg != 0 else "+0",
            "note": range_str
        }
    
    # 2. 尝试提取单个数值（如 "+0.3" 或 "约 +0.3EV"）
    single_match = re.search(r'([+-]?\d+\.?\d*)', range_str)
    if single_match:
        val = float(single_match.group(1))
        return {
            "range": f"{val:+.2f}" if val != 0 else "+0",
            "note": range_str if "约" in range_str or "微调" in range_str else ""
        }
    
    # 3. 模糊描述（如 "微调"、"略微增加"）
    if any(keyword in range_str for keyword in ["微调", "略微", "稍微", "适度"]):
        return {
            "range": "+0",
            "note": range_str
        }
    
    # 4. 默认值
    return {
        "range": "+0",
        "note": range_str
    }
```

### 2.4 需要确认

**请查看完整的 Prompt 模版代码示例**，确认：
- [ ] 范围字符串的格式是否固定？
- [ ] 是否可能只有单个值（如 `"+0.3"`）？✅ **你已确认**
- [ ] 是否可能只有描述（如 `"微调"`）？
- [ ] 是否有其他格式变体？

---

## 三、构图分析字段映射示意图

### 3.1 问题说明

**问题**：前端显示时，是否需要保持 5 个独立卡片？还是可以合并某些字段？

### 3.2 新 Prompt 结构（5个字段）

```
module_2_composition
│
├── 1. main_structure
│   └── "画面主结构分析" (文本)
│
├── 2. subject_weight
│   ├── description: "主体位置、占比" (文本)
│   └── layers: "前景/中景/远景" (文本)
│
├── 3. visual_guidance
│   ├── analysis: "线条走向分析" (文本)
│   └── path: "入口点 -> 停留点 -> 终点" (文本)
│
├── 4. ratios_negative_space
│   ├── entity_ratio: "60%" (字符串)
│   ├── space_ratio: "40%" (字符串)
│   └── distribution: "留白分布位置" (文本)
│
└── 5. style_class
    └── "构图风格归类" (文本)
```

### 3.3 前端显示方案对比（示意图）

#### 方案A：5个独立卡片（推荐）✅

```
┌─────────────────────────────────────────┐
│ 📐 画面主结构分析                        │
│ ─────────────────────────────────────── │
│ [主结构分析文本内容]                     │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 🎯 主体位置与视觉权重                    │
│ ─────────────────────────────────────── │
│ [主体位置、占比描述]                     │
│                                          │
│ 空间层次：                               │
│ [前景/中景/远景分布]                     │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 📈 线条与方向引导                        │
│ ─────────────────────────────────────── │
│ [线条走向分析文本]                       │
│                                          │
│ 视觉路径：                               │
│ [入口点 -> 停留点 -> 终点]               │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 📏 比例与留白                            │
│ ─────────────────────────────────────── │
│ [留白分布位置描述]                       │
│                                          │
│ 比例：实体 60% | 留白 40%                │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 💡 构图风格归类                          │
│ ─────────────────────────────────────── │
│ [构图风格归类文本]                       │
└─────────────────────────────────────────┘
```

**优点**：
- ✅ 结构清晰，每个字段独立显示
- ✅ 符合新 Prompt 的结构，数据映射简单
- ✅ 信息完整，不丢失任何细节

**缺点**：
- ⚠️ 需要修改前端（从7段改为5段）

---

#### 方案B：合并部分字段（3个卡片）

```
┌─────────────────────────────────────────┐
│ 📐 画面结构与主体                        │
│ ─────────────────────────────────────── │
│ 主结构分析：                             │
│ [主结构分析文本]                         │
│                                          │
│ 主体位置与视觉权重：                     │
│ [主体位置、占比描述]                     │
│ 空间层次：[前景/中景/远景]               │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 📈 视觉引导与比例                        │
│ ─────────────────────────────────────── │
│ 线条与方向引导：                         │
│ [线条走向分析文本]                       │
│ 视觉路径：入口点 -> 停留点 -> 终点       │
│                                          │
│ 比例与留白：                             │
│ [留白分布位置描述]                       │
│ 比例：实体 60% | 留白 40%                │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 💡 构图风格归类                          │
│ ─────────────────────────────────────── │
│ [构图风格归类文本]                       │
└─────────────────────────────────────────┘
```

**优点**：
- ✅ 卡片数量更少，界面更简洁
- ✅ 相关字段合并，逻辑更清晰

**缺点**：
- ⚠️ 需要重新组织内容
- ⚠️ 可能丢失某些细节
- ⚠️ 不符合新 Prompt 的结构

---

#### 方案C：保持7段结构（向后兼容）

```
将新结构的5个字段映射到现有的7段：

1. 画面主结构分析
   ← main_structure

2. 主体位置与视觉权重
   ← subject_weight.description

3. 线条与方向引导
   ← visual_guidance.analysis

4. 空间层次与分区
   ← subject_weight.layers

5. 比例与留白
   ← ratios_negative_space.distribution
   + ratios_negative_space.entity_ratio
   + ratios_negative_space.space_ratio

6. 视觉平衡与动势
   ← visual_guidance.path

7. 构图风格归类与改进建议
   ← style_class
```

**优点**：
- ✅ 无需修改前端
- ✅ 保持现有设计

**缺点**：
- ⚠️ 需要智能映射，可能丢失信息
- ⚠️ 不符合新 Prompt 的结构
- ⚠️ 某些字段需要拆分或合并

---

### 3.4 推荐方案

**推荐：方案A（5个独立卡片）** ✅

**理由**：
1. **符合新 Prompt 结构**：数据映射简单，无需智能拆分或合并
2. **信息完整**：每个字段独立显示，不丢失任何信息
3. **前端改动可控**：只需修改 `CompositionSection.tsx`，将7段改为5段
4. **用户体验好**：结构清晰，便于理解

---

## 四、总结

### 4.1 需要确认的问题

1. **直方图数据格式**
   - [ ] `simulated_histogram_data` 是否包含 `reference` 和 `user` 两个字段？
   - [ ] 如果只有一个，是哪张图？

2. **范围字符串格式**
   - [x] 是否可能只有单个值（如 `"+0.3"`）？✅ **已确认**
   - [ ] 是否可能只有描述（如 `"微调"`）？
   - [ ] 是否有其他格式变体？

3. **构图分析显示方案**
   - [x] 选择方案A（5个独立卡片）？✅ **已确认**
   - [ ] 还是方案B（合并部分字段）？
   - [ ] 还是方案C（保持7段结构）？

---

**请提供完整的 Prompt 模版代码示例，以便我准确分析直方图数据格式！**

