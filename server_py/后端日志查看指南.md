# 后端日志查看指南

## 日志系统说明

后端使用 **loguru** 作为日志库，日志默认输出到**控制台（标准输出）**。

---

## 方法一：查看实时日志（推荐）

### 1. 如果后端正在运行

**在启动后端的终端窗口中**，日志会实时显示。

**启动后端的方法**：
```bash
cd /Users/dengzhaoyu/Desktop/TepVis/AI产品/P-Style/server_py

# 方法1：使用 run.py
python3 run.py

# 方法2：直接使用 uvicorn
uvicorn app.main:app --host 0.0.0.0 --port 8081 --reload
```

**日志输出位置**：启动后端的终端窗口

### 2. 如果后端在后台运行

如果后端在后台运行（使用 `nohup` 或 `screen`/`tmux`），需要：

**查找后端进程**：
```bash
# 查找 Python 进程
ps aux | grep uvicorn
ps aux | grep "app.main:app"

# 或者查找端口 8081
lsof -i :8081
```

**查看后台日志**：
- 如果使用 `nohup`：查看 `nohup.out` 文件
- 如果使用 `screen`：`screen -r <session_name>`
- 如果使用 `tmux`：`tmux attach`

---

## 方法二：搜索关键日志信息

### 1. 搜索"第一层排查"日志（完整 Prompt）

```bash
# 在终端中搜索（如果后端正在运行，需要另一个终端）
# 或者使用 grep 搜索日志文件（如果有）

# 搜索完整 Prompt
grep -A 50 "【第一层排查：真相层】" <日志文件或终端输出>
```

### 2. 搜索 Gemini 原始响应

```bash
# 搜索 Gemini 原始响应开始标记
grep -A 100 "========== GEMINI RAW OUTPUT START ==========" <日志文件或终端输出>

# 或者直接查看保存的响应文件
ls -lt /tmp/gemini_response_part1_*.json | head -1
cat /tmp/gemini_response_part1_*.json | jq .  # 需要安装 jq
```

### 3. 搜索关键字段验证

```bash
# 搜索 spatial_analysis 字段验证
grep "spatial_analysis" <日志文件或终端输出>

# 搜索 overlays 字段验证
grep "overlays" <日志文件或终端输出>

# 搜索 ref_visual_subject_box（破坏性命名）
grep "ref_visual_subject_box" <日志文件或终端输出>
```

---

## 方法三：查看保存的 Gemini 响应文件

后端会自动将 Gemini 的原始响应保存到文件：

**文件位置**：`/tmp/gemini_response_part1_<timestamp>.json`

**查看最新文件**：
```bash
# 列出所有响应文件（按时间排序）
ls -lt /tmp/gemini_response_part1_*.json

# 查看最新的响应文件
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1)

# 使用 jq 格式化查看（如果安装了 jq）
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1) | jq .

# 搜索特定字段
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1) | grep -i "spatial_analysis"
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1) | grep -i "ref_visual_subject_box"
```

---

## 方法四：使用日志重定向（如果后端未运行）

如果后端未运行，可以启动后端并将日志重定向到文件：

```bash
cd /Users/dengzhaoyu/Desktop/TepVis/AI产品/P-Style/server_py

# 启动后端并保存日志到文件
python3 run.py 2>&1 | tee backend.log

# 或者使用 uvicorn
uvicorn app.main:app --host 0.0.0.0 --port 8081 --reload 2>&1 | tee backend.log
```

**然后可以**：
- 实时查看：`tail -f backend.log`
- 搜索日志：`grep "关键词" backend.log`
- 查看完整日志：`cat backend.log`

---

## 关键日志标记

### 第一层排查日志（完整 Prompt）

**标记**：`【第一层排查：真相层】========== 完整 Prompt 字符串（发送给 Gemini 前） ==========`

**位置**：`server_py/app/routes/analyze.py:417` 之前

**内容**：
- 完整 Prompt 字符串
- 完整 Contents 结构（JSON 格式）

### Gemini 原始响应日志

**标记**：`========== GEMINI RAW OUTPUT START ==========`

**位置**：`server_py/app/routes/analyze.py:470`

**内容**：
- Gemini 返回的完整原始响应
- 保存到文件：`/tmp/gemini_response_part1_<timestamp>.json`

### 字段验证日志

**标记**：
- `✅ 清洗后的 JSON 包含 'spatial_analysis' 字段`
- `⚠️ 清洗后的 JSON 不包含 'spatial_analysis' 字段`
- `✅ 清洗后的 JSON 包含 'ref_visual_subject_box' 字段（破坏性命名）`

**位置**：`server_py/app/routes/analyze.py:492-505`

---

## 快速排查命令

### 1. 查看完整 Prompt（第一层排查）

```bash
# 如果后端正在运行，在另一个终端执行
# 或者查看日志文件

# 搜索完整 Prompt
grep -A 200 "【第一层排查：真相层】" <日志源> | head -250
```

### 2. 查看 Gemini 原始响应

```bash
# 查看最新的响应文件
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1)

# 或者搜索日志中的原始响应
grep -A 500 "========== GEMINI RAW OUTPUT START ==========" <日志源> | head -550
```

### 3. 验证字段是否存在

```bash
# 检查 spatial_analysis
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1) | grep -i "spatial_analysis"

# 检查 ref_visual_subject_box
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1) | grep -i "ref_visual_subject_box"

# 检查 ref_visual_mass_polygon
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1) | grep -i "ref_visual_mass_polygon"
```

---

## 日志级别说明

后端使用 loguru，日志级别包括：
- **DEBUG**：详细调试信息（`logger.debug()`）
- **INFO**：一般信息（`logger.info()`）
- **WARNING**：警告信息（`logger.warning()`）
- **ERROR**：错误信息（`logger.error()`）

**默认日志级别**：INFO（DEBUG 日志不会显示，除非修改配置）

---

## 常见问题

### Q1: 找不到日志输出

**可能原因**：
1. 后端未运行
2. 后端在后台运行，日志输出到其他位置
3. 日志被重定向到文件

**解决方法**：
1. 检查后端是否运行：`lsof -i :8081`
2. 查找日志文件：`find . -name "*.log" -o -name "nohup.out"`
3. 重新启动后端并查看终端输出

### Q2: 日志太多，找不到关键信息

**解决方法**：
使用 `grep` 过滤：
```bash
# 只查看 Part1 相关日志
grep "Part1" <日志源>

# 只查看错误日志
grep "ERROR\|错误" <日志源>

# 只查看第一层排查日志
grep "第一层排查" <日志源>
```

### Q3: 如何查看历史日志

**解决方法**：
1. 如果使用日志重定向：查看 `backend.log` 文件
2. 如果使用 systemd：`journalctl -u <service_name>`
3. 查看保存的 Gemini 响应文件：`/tmp/gemini_response_part1_*.json`

---

## 推荐工作流程

### 1. 启动后端并查看实时日志

```bash
cd /Users/dengzhaoyu/Desktop/TepVis/AI产品/P-Style/server_py
python3 run.py
```

### 2. 在另一个终端执行请求（或使用前端）

### 3. 在启动后端的终端中查看日志

- 查找 `【第一层排查：真相层】` 确认 Prompt 是否正确
- 查找 `========== GEMINI RAW OUTPUT START ==========` 查看原始响应
- 查找 `✅ 清洗后的 JSON 包含` 确认字段是否存在

### 4. 如果需要详细分析，查看保存的响应文件

```bash
cat $(ls -t /tmp/gemini_response_part1_*.json | head -1) | jq .
```

---

## 相关文件

- `server_py/app/routes/analyze.py` - Part1 分析路由（日志输出位置）
- `server_py/app/services/gemini_service.py` - Gemini 服务（API 调用日志）
- `server_py/app/services/analysis_formatter.py` - 结果格式化（格式化日志）
- `/tmp/gemini_response_part1_*.json` - Gemini 原始响应文件

---

## 更新日期

2025-01-XX

