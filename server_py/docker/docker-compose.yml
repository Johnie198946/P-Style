# ===============================================
# P-Style 高保真渲染服务 Docker Compose 配置
# 
# 服务说明：
# - pstyle-rawtherapee: RawTherapee CLI 渲染容器
#   - 使用 Debian 包管理器安装（版本 5.9）
#   - 支持完整渲染和 PP3 配置文件
# ===============================================

version: '3.8'

services:
  # RawTherapee CLI 高保真渲染服务
  pstyle-rawtherapee:
    build:
      context: .
      dockerfile: Dockerfile.rawtherapee
    image: pstyle-rawtherapee:5.9
    container_name: pstyle-rawtherapee
    
    # 挂载卷：共享图片和配置
    volumes:
      # 输入图片目录（用户上传的图片）
      - ../storage/uploads:/app/input:ro
      # 输出目录（渲染后的图片）
      - ../storage/rendered:/app/output:rw
      # PP3 sidecar 文件目录
      - ../storage/xmp:/app/pp3:rw
      # 缓存目录
      - ../storage/cache/rendered:/app/cache:rw
    
    # 环境变量
    environment:
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
    
    # 资源限制（防止内存溢出）
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # 重启策略
    restart: unless-stopped
    
    # 保持容器运行（等待 exec 调用）
    command: ["/bin/bash", "-c", "tail -f /dev/null"]
    
    # 健康检查（使用 -h 参数，忽略退出码）
    healthcheck:
      test: ["CMD-SHELL", "rawtherapee-cli -h 2>&1 | grep -q 'RawTherapee' || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# 网络配置（可选，如果需要与后端服务通信）
networks:
  default:
    name: pstyle-network
    driver: bridge

# 卷配置（持久化存储）
volumes:
  darktable-cache:
    driver: local
