# 参数校准方案 v3 - 基于参考图对比分析

## 一、参考图深度分析（图1）

### 1.1 摄影风格
**风格识别**：**温暖室内人像 / 电影感亲密场景**
- 整体氛围：温暖、亲密、略带忧郁或浪漫
- 色调特征：**青绿色调 + 暖色高光**（Teal & Orange 变体）
- 光影特征：**柔和的侧光**，高光区域有温暖的黄色/橙色，阴影区域有绿色调

### 1.2 光影逻辑
**直方图特征**：
- **暗部**：**褪色处理（Faded Black）**，黑位提升，避免死黑
- **高光**：**抑制但不溢出**，保持细节，呈现温暖的黄色/橙色
- **对比度**：**中等偏低**，营造柔和、电影感的氛围
- **整体亮度**：**中等偏亮**，但不过曝

### 1.3 色彩映射
**高光主色调**：
- **Hex**: `#FFB84D` ~ `#FFA500`（温暖的橙色/黄色）
- **描述**：温暖的黄色/橙色，饱和度中等偏高

**阴影主色调**：
- **Hex**: `#2D5A3D` ~ `#4A7C59`（深绿色/青绿色）
- **描述**：深绿色/青绿色，饱和度中等

**关键颜色偏移**：
- **绿色**：**偏青**（Hue 向青色方向偏移），饱和度中等，明度中等
- **红色/橙色**：**偏暖**（Hue 向红色方向偏移），饱和度中等偏高，明度偏高
- **蓝色**：**偏青**（Hue 向青色方向偏移），饱和度中等，明度中等偏高
- **黄色**：**偏橙**（Hue 向橙色方向偏移），饱和度中等，明度偏高

---

## 二、诊断对比分析

### 2.1 LR调整后的用户图（图2）vs 参考图（图1）

**主要差距**：

1. **曝光**：
   - **差距**：用户图整体亮度可能略低于参考图
   - **需要调整**：Exposure +0.3 ~ +0.8 EV

2. **白平衡**：
   - **差距**：用户图可能偏冷，参考图偏暖
   - **需要调整**：Temperature +200 ~ +500K（偏暖），Tint -5 ~ -15（偏绿）

3. **色彩分离**：
   - **差距**：用户图可能缺少青绿色调，高光区域可能不够温暖
   - **需要调整**：
     - **阴影**：Hue 180-210°（青绿色），Saturation 15-30%
     - **高光**：Hue 30-45°（橙色），Saturation 20-40%

4. **曲线**：
   - **差距**：用户图可能缺少"褪色感"（Faded Black）
   - **需要调整**：RGB曲线起点 y=20-30（提升黑位），S型曲线（暗部抬起，高光抑制）

5. **颜色校准**：
   - **差距**：用户图可能缺少青橙色调的基础
   - **需要调整**：
     - **蓝原色**：Hue -30 ~ -60（偏青），Saturation +20 ~ +40
     - **绿原色**：Hue -10 ~ -20（偏青），Saturation +10 ~ +20
     - **红原色**：Hue +5 ~ +15（偏橙），Saturation +10 ~ +20

### 2.2 系统渲染图（图3）vs LR调整后的用户图（图2）

**主要差距**：

1. **曝光**：
   - **差距**：系统渲染图可能整体过亮或过暗
   - **偏离度**：±0.5 EV

2. **白平衡**：
   - **差距**：系统渲染图可能偏黄偏暖，缺少青绿色调
   - **偏离度**：Temperature +300 ~ +500K（过度偏暖），Tint +5 ~ +15（过度偏洋红）

3. **色彩分离**：
   - **差距**：系统渲染图可能缺少青绿色调，高光区域可能过度偏黄
   - **偏离度**：
     - **阴影**：Hue 偏离 -30 ~ -60°（缺少青绿色），Saturation 偏离 -15 ~ -30%
     - **高光**：Hue 偏离 +15 ~ +30°（过度偏黄），Saturation 偏离 -10 ~ -20%

4. **曲线**：
   - **差距**：系统渲染图可能缺少"褪色感"（Faded Black），黑位可能过低
   - **偏离度**：RGB曲线起点 y=0（应该是 y=20-30），缺少暗部抬起

5. **颜色校准**：
   - **差距**：系统渲染图可能缺少青橙色调的基础，蓝原色可能未偏青
   - **偏离度**：
     - **蓝原色**：Hue 偏离 -30 ~ -60°（未偏青），Saturation 偏离 -20 ~ -40%
     - **绿原色**：Hue 偏离 -10 ~ -20°（未偏青），Saturation 偏离 -10 ~ -20%
     - **红原色**：Hue 偏离 +5 ~ +15°（未偏橙），Saturation 偏离 -10 ~ -20%

6. **HSL调整**：
   - **差距**：系统渲染图可能绿色偏黄，未能偏青
   - **偏离度**：
     - **绿色**：Hue 偏离 -15 ~ -30°（偏黄而非偏青），Saturation 偏离 +10 ~ +20%（过度饱和）
     - **蓝色**：Hue 偏离 -10 ~ -20°（未偏青），Saturation 偏离 +10 ~ +20%（过度饱和）

---

## 三、调色校准配方（具体参数方向和预估数值）

### 3.1 基础面板 (Basic)

| 参数 | 当前值 | 目标值 | 调整方向 | 说明 |
|------|--------|--------|----------|------|
| **色温 (Temperature)** | 5500K | **5800-6000K** | **+300 ~ +500K** | 统一白平衡，偏暖以匹配参考图的温暖氛围 |
| **色调 (Tint)** | 0 | **-5 ~ -15** | **偏绿** | 减少洋红，增加绿色调，为青绿色调打基础 |
| **曝光 (Exposure)** | 0 | **+0.3 ~ +0.8 EV** | **提亮** | 匹配参考图的整体亮度 |
| **对比度 (Contrast)** | 0 | **-5 ~ +5** | **微调** | 保持柔和，避免过度对比 |
| **高光 (Highlights)** | 0 | **-20 ~ -40** | **抑制** | 保护高光细节，避免溢出 |
| **阴影 (Shadows)** | 0 | **+30 ~ +60** | **大幅提亮** | 提亮阴影，增加通透感，避免死黑 |
| **白色 (Whites)** | 0 | **+10 ~ +30** | **提升** | 增加高光区域的亮度，但不过度 |
| **黑色 (Blacks)** | 0 | **+15 ~ +30** | **大幅提升** | **Faded Black 关键**，提升黑位，避免死黑 |

### 3.2 曲线 (Tone Curve)

**RGB曲线形态**：
- **起点 (0, 0)** → **调整为 (0, 20-30)**：**暗部抬起，Faded Black 效果**
- **中间点 (128, 128)** → **保持或微调**：保持中间调平衡
- **终点 (255, 255)** → **保持或微调**：保持高光细节

**曲线类型**：**S型曲线（暗部抬起，高光抑制）**
- **暗部**：抬起 20-30 点，营造褪色感
- **高光**：抑制 10-20 点，保护细节

**预估控制点**：
```json
{
  "rgb": [
    {"x": 0, "y": 25},      // 起点抬起
    {"x": 64, "y": 70},      // 暗部抬起
    {"x": 128, "y": 128},    // 中间调保持
    {"x": 192, "y": 185},    // 高光微调
    {"x": 255, "y": 245}     // 高光抑制
  ]
}
```

### 3.3 HSL / 混色器

**针对画面中主要颜色的具体调整**：

| 颜色 | 色相 (Hue) | 饱和度 (Sat) | 明亮度 (Lum) | 说明 |
|------|-----------|-------------|-------------|------|
| **红色** | **+5 ~ +15** | **+10 ~ +20** | **+5 ~ +15** | 偏暖，增加饱和度，提亮（匹配参考图的温暖高光） |
| **橙色** | **+5 ~ +10** | **+5 ~ +15** | **+10 ~ +20** | 偏暖，增加饱和度，大幅提亮（**肤色处理关键**） |
| **黄色** | **-5 ~ -10** | **-10 ~ -20** | **+10 ~ +20** | 偏绿，降低饱和度，提亮（减少黄色，增加绿色调） |
| **绿色** | **-15 ~ -30** | **-10 ~ -30** | **+20 ~ +40** | **偏青关键**，降低饱和度，大幅提亮（营造青绿色调） |
| **青色 (Aqua)** | **-5 ~ -10** | **+5 ~ +15** | **+10 ~ +20** | 保持或微调，增加饱和度，提亮 |
| **蓝色** | **-10 ~ -20** | **-20 ~ -40** | **+20 ~ +40** | **偏青关键**，降低饱和度，大幅提亮（营造青绿色调） |
| **紫色** | **0** | **-10 ~ -20** | **+5 ~ +15** | 降低饱和度，提亮 |
| **洋红** | **+5 ~ +10** | **+5 ~ +15** | **+5 ~ +15** | 偏暖，增加饱和度，提亮 |

**重点：肤色处理**：
- **橙色 HSL**：Hue +5 ~ +10（偏暖），Saturation +5 ~ +15（增加饱和度），Luminance +10 ~ +20（提亮）
- **红色 HSL**：Hue +5 ~ +15（偏暖），Saturation +10 ~ +20（增加饱和度），Luminance +5 ~ +15（提亮）

### 3.4 颜色分级 (Color Grading)

**中间调 (Midtones)**：
- **色轮方向**：**180-210°（青绿色）**
- **饱和度**：**15-30%**
- **说明**：为整体画面注入青绿色调

**阴影 (Shadows)**：
- **色轮方向**：**180-210°（青绿色）**
- **饱和度**：**20-40%**
- **说明**：阴影区域注入青绿色调，营造电影感

**高光 (Highlights)**：
- **色轮方向**：**30-45°（橙色）**
- **饱和度**：**25-45%**
- **说明**：高光区域注入温暖的橙色，营造温暖氛围

### 3.5 校准 (Calibration) - 模仿胶片色的关键

**红原色 (Red Primary)**：
- **色相 (Hue)**：**+5 ~ +15**（偏橙）
- **饱和度 (Saturation)**：**+10 ~ +20**
- **说明**：增强红色/橙色的温暖感

**绿原色 (Green Primary)**：
- **色相 (Hue)**：**-10 ~ -20**（偏青）
- **饱和度 (Saturation)**：**+10 ~ +20**
- **说明**：增强绿色/青色的青绿色调

**蓝原色 (Blue Primary)**：
- **色相 (Hue)**：**-30 ~ -60**（**大幅偏青，关键**）
- **饱和度 (Saturation)**：**+20 ~ +40**（**大幅增加，关键**）
- **说明**：**青橙色调的基础**，蓝原色偏青 + 高饱和度 = Teal & Orange 基础

**阴影色调 (Shadows Tint)**：
- **值**：**-5 ~ -15**（偏绿）
- **说明**：阴影区域整体偏绿，增强青绿色调

### 3.6 效果 (Effects)

**颗粒感 (Grain)**：
- **数量**：**10-20**
- **大小**：**20-30**
- **粗糙度**：**40-60**
- **说明**：增加轻微颗粒感，营造胶片感

**晕影 (Vignette)**：
- **数量**：**-10 ~ -20**（轻微压暗边缘）
- **中点**：**50**
- **圆度**：**+50**
- **羽化**：**+50**
- **说明**：轻微压暗边缘，突出中心主体

---

## 四、系统渲染引擎校准方案（后端更新）

### 4.1 白平衡模块校准

**当前问题**：
- 系统渲染图偏黄偏暖，缺少青绿色调
- 冷色调时绿通道增益不足，未能产生正宗的青色

**校准方案**：

```python
# server_py/app/services/python_render_engine.py
# _apply_white_balance() 方法

# 【校准 v3】增强冷色调的青色效果
temp_factor = temp / 100.0 * 0.90  # 从 0.85 增大到 0.90

if temp < 0:
    # 偏冷（青蓝色调）：增加蓝色，减少红色，同时增加绿色产生青感
    img[:, :, 0] = img[:, :, 0] * (1 + temp_factor)  # R 减少
    img[:, :, 2] = img[:, :, 2] * (1 - temp_factor)  # B 增加
    # 【校准 v3】绿通道增益从 0.5 增大到 0.65，产生更正宗的青色
    img[:, :, 1] = img[:, :, 1] * (1 - temp_factor * 0.65)  # G 增加
```

**参数更新**：
- `temp_factor`: 0.85 → **0.90**（增强冷/暖色调效果）
- `tint_factor`: 0.6 → **0.7**（增强绿/洋红效果）
- 冷色调绿通道增益: 0.5 → **0.65**（增强青色）

### 4.2 HSL模块校准

**当前问题**：
- 绿色偏黄，未能偏青
- 蓝色未偏青
- 饱和度可能过度

**校准方案**：

```python
# server_py/app/services/python_render_engine.py
# _apply_hsl() 方法

# 【校准 v3】每种颜色的色相系数（关键：绿色和蓝色偏青）
hue_coefficients = {
    'red': 1.0,
    'orange': 1.0,
    'yellow': 1.2,     # 黄色轻微偏绿
    'green': 2.0,      # 【校准 v3】从 1.8 增大到 2.0，绿色大幅偏青
    'aqua': 1.2,
    'cyan': 1.2,
    'blue': 1.8,       # 【校准 v3】从 1.5 增大到 1.8，蓝色大幅偏青
    'purple': 1.0,
    'magenta': 1.0,
}

# 【校准 v3】饱和度系数从 1.3 降低到 1.2，避免过饱和
if sat_shift != 0:
    sat_factor = 1 + sat_shift / 100.0 * 1.2  # 从 1.3 降低到 1.2
```

**参数更新**：
- 绿色色相系数: 1.8 → **2.0**（绿色大幅偏青）
- 蓝色色相系数: 1.5 → **1.8**（蓝色大幅偏青）
- 饱和度系数: 1.3 → **1.2**（避免过饱和）

### 4.3 相机校准模块校准

**当前问题**：
- 蓝原色偏青效果不足
- 绿原色偏青效果不足
- 阴影色调效果不足

**校准方案**：

```python
# server_py/app/services/python_render_engine.py
# _apply_calibration() 方法

# 2. 绿原色调整（影响绿色和青色区域）
if green_hue != 0:
    # 【校准 v3】绿原色色相偏移增强，从 0.8 增大到 1.0
    img_hsv[:, :, 0] = img_hsv[:, :, 0] + green_hue * 1.0 * green_mask

# 3. 蓝原色调整（影响蓝色和紫色区域）- 【关键：青橙色调基础】
if blue_hue != 0:
    # 【校准 v3】蓝原色偏青效果增强，从 1.0 增大到 1.2
    img_hsv[:, :, 0] = img_hsv[:, :, 0] + blue_hue * 1.2 * blue_mask
if blue_sat != 0:
    # 【校准 v3】蓝原色饱和度大幅增强，从 1.5 增大到 1.8
    sat_factor = 1 + blue_sat / 100.0 * 1.8  # 从 1.5 增大到 1.8
```

**参数更新**：
- 绿原色色相偏移系数: 0.8 → **1.0**（增强青绿色调）
- 蓝原色色相偏移系数: 1.0 → **1.2**（增强青橙色调基础）
- 蓝原色饱和度系数: 1.5 → **1.8**（大幅增强青橙色调基础）

### 4.4 黑位模块校准

**当前问题**：
- 系统渲染图可能缺少"褪色感"（Faded Black），黑位可能过低

**校准方案**：

```python
# server_py/app/services/python_render_engine.py
# _apply_whites_blacks() 方法

# 【校准 v3】黑色调整：offset 从 0.15 增大到 0.20 (Faded Black 效果)
if blacks != 0:
    black_offset = blacks / 100.0 * 0.20  # 【校准 v3】从 0.15 增大到 0.20，增强 Faded 效果
    # 正值提升黑位（Faded），负值压低黑位
    img = img + black_offset
```

**参数更新**：
- 黑位 offset: 0.15 → **0.20**（增强 Faded Black 效果）

### 4.5 对比度模块校准

**当前问题**：
- 系统渲染图可能对比度过高，缺少柔和感

**校准方案**：

```python
# server_py/app/services/python_render_engine.py
# _apply_contrast() 方法

# 【校准 v3】暗部/亮部 gamma 增强
# gamma_dark: 0.6 → 0.55, gamma_light: 0.4 → 0.35（降低对比度，增加柔和感）
if contrast > 0:
    gamma_dark = 1 + contrast / 100.0 * 0.55   # 【校准 v3】从 0.6 降低到 0.55
    gamma_light = 1 - contrast / 100.0 * 0.35  # 【校准 v3】从 0.4 降低到 0.35
```

**参数更新**：
- `gamma_dark`: 0.6 → **0.55**（降低对比度，增加柔和感）
- `gamma_light`: 0.4 → **0.35**（降低对比度，增加柔和感）

### 4.6 色彩分级模块校准

**当前问题**：
- 系统渲染图可能缺少青绿色调，高光区域可能过度偏黄

**校准方案**：

```python
# server_py/app/services/python_render_engine.py
# _apply_tint() 方法

# 【校准 v3】着色强度从 0.6 增大到 0.7，增强着色效果
strength = saturation / 100.0 * 0.7  # 从 0.6 增大到 0.7
```

**参数更新**：
- 着色强度: 0.6 → **0.7**（增强着色效果）

---

## 五、校准参数汇总表

| 模块 | 参数 | 原值 (v2) | 校准后 (v3) | 说明 |
|------|------|-----------|-------------|------|
| **白平衡** | temp_factor | 0.85 | **0.90** | 增强冷/暖色调效果 |
| **白平衡** | tint_factor | 0.6 | **0.7** | 增强绿/洋红效果 |
| **白平衡** | 冷色调绿通道增益 | 0.5 | **0.65** | 增强青色 |
| **对比度** | gamma_dark | 0.6 | **0.55** | 降低对比度，增加柔和感 |
| **对比度** | gamma_light | 0.4 | **0.35** | 降低对比度，增加柔和感 |
| **黑位** | offset | 0.15 | **0.20** | 增强 Faded Black |
| **HSL** | 绿色色相系数 | 1.8 | **2.0** | 绿色大幅偏青 |
| **HSL** | 蓝色色相系数 | 1.5 | **1.8** | 蓝色大幅偏青 |
| **HSL** | 饱和度系数 | 1.3 | **1.2** | 避免过饱和 |
| **校准** | 绿原色色相偏移系数 | 0.8 | **1.0** | 增强青绿色调 |
| **校准** | 蓝原色色相偏移系数 | 1.0 | **1.2** | 增强青橙色调基础 |
| **校准** | 蓝原色饱和度系数 | 1.5 | **1.8** | 大幅增强青橙色调基础 |
| **色彩分级** | 着色强度 | 0.6 | **0.7** | 增强着色效果 |

---

## 六、实施步骤

1. **更新 `python_render_engine.py`**：
   - 更新 `_apply_white_balance()` 方法
   - 更新 `_apply_contrast()` 方法
   - 更新 `_apply_whites_blacks()` 方法
   - 更新 `_apply_hsl()` 方法
   - 更新 `_apply_calibration()` 方法
   - 更新 `_apply_tint()` 方法

2. **测试验证**：
   - 使用参考图和用户图进行渲染测试
   - 对比系统渲染图与 LR 调整后的用户图
   - 验证偏离度是否降低

3. **迭代优化**：
   - 根据测试结果微调参数
   - 记录校准效果
   - 更新文档

---

## 七、预期效果

**校准后预期效果**：
- ✅ 系统渲染图与 LR 调整后的用户图在色彩、曝光、对比度等方面更加接近
- ✅ 青绿色调更加明显，绿色和蓝色正确偏青
- ✅ 高光区域呈现温暖的橙色，而非过度偏黄
- ✅ 暗部呈现褪色感（Faded Black），避免死黑
- ✅ 整体画面更加柔和，对比度适中
- ✅ 色彩分级效果更加明显，青橙色调基础更加稳固

---

**文档版本**：v3  
**创建日期**：2024-12  
**基于**：参考图（图1）、LR调整后的用户图（图2）、系统渲染图（图3）对比分析



