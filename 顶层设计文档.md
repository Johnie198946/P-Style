# 🧠 QuantaNova PhotoStyle Clone - 顶层设计文档 V4.0

> 本文为 2025-11-09 版本，聚焦“最小改动迭代”策略，整理前后端全部有效规范。所有未列出的旧约定视为废弃。

---

## 1. 项目总览

### 1.1 产品定位
- **核心价值**：解析摄影作品风格 → 生成专业化 Lightroom / Photoshop 参数与工作流。
- **关键特性**：两阶段分析（Part1 草案 / Part2 执行）、结构化输出、专业构图七段分析、可导出文件。

### 1.2 用户旅程
```
上传源图（必填）+ 目标图（选填）
    ↓
阶段一 / Part1（基础洞察，自动触发）
  • 专业摄影点评
  • 构图分析（七大板块）
  • 光影参数
  • 色彩基调 & 风格提示
  • 工作流思路草案（Lightroom / Photoshop / 其它）
    ↓
阶段二 / Part2（用户按需触发执行类卡片时调用）
  • 色彩方案（含曲线、调色思路）
  • Lightroom 详细参数（全面板 + 局部调整）
  • Photoshop 步骤（曲线、选择性色、蒙版、技巧说明）
  • 工作流对齐说明（沿用 / 调整 / 新增）
    ↓
交付
  ✓ 自然语言报告
  ✓ JSON 结果（结构化）
  ✓ XMP / JSX 导出
  ✓ 参数复制、手动校准提示
```

### 1.3 目标用户
- 摄影师 / 后期修图师：批量复刻风格、规范流程。
- 摄影教育人士：教学范例与讲解材料。
- 摄影爱好者：学习专业调色与构图语言。

---

## 2. 技术架构

### 2.1 全局架构概览
```
┌──────────────── 前端 (React + Vite + TS) ────────────────┐
│ 上传组件 / Loading / 结果展示 / API 封装 / 数据转换 / UI │
└────────────────────────────────────────────────────┘
                              │REST API
┌─────────────────────────── 后端 (Node.js + Express) ───────┐
│ 路由层 → 服务层（Gemini / 映射 / 导出）→ 数据访问层 → 日志 │
└────────────────────────────────────────────────────┘
                              │
┌─────────────────────────── 数据层 (MySQL) ────────────────┐
│ analysis_tasks / uploads / export_files / users (规划)     │
└────────────────────────────────────────────────────┘
                              │
┌─────────────────────────── 外部服务 ───────────────────────┐
│ Gemini Vision API / 代理 (ClashX) / 对象存储(规划) / Redis │
└────────────────────────────────────────────────────┘
```

### 2.2 运行环境
| 组件         | 端口 / 说明                   |
|--------------|------------------------------|
| 前端 Vite    | http://localhost:3001        |
| 后端 Express | http://localhost:8081        |
| MySQL (Docker)| localhost:3309               |
| 代理 (ClashX)| http://127.0.0.1:7890        |

---

## 3. 功能模块定义

### 3.1 前端模块
| 模块 | 文件 | 说明 |
|------|------|------|
| 图片上传 | `src/components/PhotoUploadZone.tsx` | 拖拽/点击上传、磁吸动画、Base64 预览、格式校验 |
| 分析进度 | `src/App.tsx` Loading 区域 | Part1/Part2 状态、全屏虚化、失败重试提示 |
| 结果展示 | `src/components/AdjustmentResults.tsx` | 多卡片呈现点评/构图/光影/色彩/LR/PS、导出、复制功能 |
| 构图分析卡片 | `src/components/sections/CompositionSection.tsx` | 七大板块 UI（画面主结构~构图风格建议），统一样式 |
| 光影、色彩、LR/PS 分析 | `src/components/sections/*.tsx` | 参数分段、曲线渲染、hover 提示、图片对比 Modal |
| API 封装 | `src/services/api.ts` | `/api/analyze/part1`、`/part2`、导出接口等 |
| 数据转换 | `src/utils/dataConverter.ts` | Gemini → 前端结构、自然语言兜底解析、构图七段提取 |

### 3.2 后端模块
| 层级 | 文件 | 职责 |
|------|------|------|
| 路由层 | `src/routes/analyzeRoutes.js` | `/api/analyze/part1` `/part2` `/`(combined) |
| 路由层 | `src/routes/uploadRoutes.js` | `/api/photos/upload`，记录上传与相似度 |
| 服务层 | `src/services/analyzeService.js` | 图片 DataURL、元数据提取、Gemini 调用、任务落库 |
| 服务层 | `src/services/analysisFormatter.js` | Gemini 输出标准化映射、缺失段落告警 |
| 服务层 | `src/services/uploadService.js` | `uploads` 表存取、任务关联 |
| Prompt 模板 | `src/services/promptTemplate.js` | Part1/Part2 Prompt、上下文拼接、输出格式要求 |
| Gemini 调度 | `src/services/geminiService.js` | 代理配置、重试、超时、响应解析、日志 |
| 色彩映射 | `src/services/colorMappingService.js` | Gemini 结果到 Lightroom/Photoshop 参数的二次结构化 |
| 导出服务 | `src/services/exportService.js` | XMP/JSX/JSON 文件生成 |
| 任务存储 | `src/services/taskService.js` | `analysis_tasks` CURD（JSON 字段 JSON.stringify） |
| 配置 | `src/config/env.js`、`appConfig.js` | 环境变量加载、超时/重试配置 |
| 工具 | `src/utils/*` | 文件→DataURL、EXIF 提取、async 队列、日志等 |

### 3.3 规划中模块（待迭代实现）
| 模块 | 说明 |
|------|------|
| 历史任务列表 | `GET /api/analyze/history` 返回分页列表（规划中） |
| 用户 & 头像 | `/api/user/avatar/*`、`users` 表；用于多用户管理 |
| 缓存层 | Redis 缓存 Gemini 成功结果（基于 source/target 哈希） |
| 相似度组件 | image-hash + 深度特征（规划中） |

---

## 4. 两阶段分析逻辑

### 4.1 阶段一（Part1）
- **触发**：用户点击“开始 AI 分析”。
- **输出**：
  - 专业摄影点评（自然语言 + `professional_evaluation` JSON）
  - 构图七段分析 (`composition.advanced_sections` 七条必填)
  - 光影参数 (`lighting`：趋势 / key handles / 纹理 / 后期动作)
  - 色彩基调与可行性 (`analysis_meta.conversion_feasibility` 等)
  - 工作流草案 (`workflow_draft`：阶段名、目标、关键动作、风险、alignment)
- **上下文存储**：源/目标图 Base64、EXIF、Part1 自然语言、草案、taskId 全部写入 `analysis_tasks`。

### 4.2 阶段二（Part2）
- **触发**：前端点击“色彩方案 / Lightroom / Photoshop”卡片，且 `stage2Ready` 为 false。
- **输入上下文**：Part1 保存的 `workflow_draft`、`part1_summary`、源/目标图 DataURL。
- **输出**：
  - 色彩方案（RGB 曲线、调色思路、`color_mapping`）
  - Lightroom 参数（基础面板、HSL、Color Grading、细节、局部调整、调色思路）
  - Photoshop 步骤（曲线四通道、选择性色、色彩平衡、蒙版、Camera Raw 等）
  - 工作流执行总结 (`workflow_final`、`workflow_alignment_notes`)
- **缓存策略**：成功后 `analysis_tasks.part2_completed=1`，以后点击直接读取。

### 4.3 Combined 模式
- **用途**：一次性完成 Part1 + Part2（调试或批量生成时使用）。
- **行为**：同 Part1/Part2，统一保存结构；前端默认不调用。

### 4.4 结构化结果映射
- **分析阶段**：Part1/Part2/Combined 全部在服务层调用 `analysisFormatter`。
- **输出内容**：`review`、`composition`、`lighting`、`color`、`workflow`、`execution`、`meta` 六大块。
- **落库策略**：`analysis_tasks.structured_result` 保存规范对象；若旧任务缺失该字段，查询接口会即时重新映射。
- **质量监控**：当构图七段缺失内容时，自动写入日志 `warn` 并在 `meta.notes` 登记问题，供前端提示。

---

## 5. API 设计（当前 + 规划）

### 5.1 已实现
| Method | Endpoint | 描述 |
|--------|----------|------|
| POST | `/api/analyze/part1` | 阶段一分析，返回 `analysis` 原始 JSON + `structuredAnalysis` 规范对象 + 自然语言 |
| POST | `/api/analyze/part2` | 阶段二分析，需提供 taskId，落库并回传结构化数据 |
| POST | `/api/analyze` | combined 模式（调试用） |
| GET | `/api/analyze/:taskId` | 查询任务详情，若库中缺失结构化结果会即时映射并返回 |
| POST | `/api/photos/upload` | 上传源/目标照片，返回 uploadId、相似度估算 |
| GET | `/api/export/json?taskId=` | 导出 JSON |
| GET | `/api/export/xmp?taskId=` | 导出 Lightroom XMP |
| GET | `/api/export/jsx?taskId=` | 导出 Photoshop JSX |

### 5.2 规划中
| Method | Endpoint | 说明 |
|--------|----------|------|
| POST | `/api/photos/upload` | 上传源/目标照片，返回 uploadId、相似度、可选对象存储 URL |
| GET | `/api/analyze/:taskId` | 查询单个任务，输出标准结构 |
| GET | `/api/analyze/history?limit=20` | 查询最近任务列表 |
| POST | `/api/user/avatar/upload` | 上传头像（multipart） |
| GET | `/api/user/avatar/:userId` | 获取头像 |
| DELETE | `/api/user/avatar/:userId` | 删除头像 |

---

## 6. 数据模型

### 6.1 已落地：`analysis_tasks`
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(36) | UUID，任务标识 |
| source_image_data | LONGTEXT | Base64 源图 |
| target_image_data | LONGTEXT | Base64 目标图（可空） |
| gemini_result | JSON | 原始 Gemini 返回（保持完整结构） |
| structured_result | JSON | 规范映射后的 review/composition/... 汇总 |
| mapping_result | JSON | colorMapping 二次结构化结果 |
| part1_summary | LONGTEXT | Part1 自然语言摘要 |
| workflow_draft | LONGTEXT | Part1 工作流草案 |
| workflow_final | LONGTEXT | Part2 工作流成品 |
| workflow_alignment_notes | LONGTEXT | 草案 vs 执行差异 |
| natural_language_part1 | LONGTEXT | Part1 全量自然语言 |
| natural_language_part2 | LONGTEXT | Part2 全量自然语言 |
| part2_completed | TINYINT | 0/1 |
| status | VARCHAR(20) | `pending` / `part1_completed` / `completed` / `failed` |
| created_at / updated_at | TIMESTAMP | 自动维护 |

### 6.2 已落地：`uploads`
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(64) | UUID |
| source_image_data | LONGTEXT | Base64 源图（后续替换为对象存储 URL） |
| target_image_data | LONGTEXT | Base64 目标图（可空） |
| source_image_url | TEXT | 预留对象存储 URL |
| target_image_url | TEXT | 预留对象存储 URL |
| similarity_score | DECIMAL(5,2) | 粗粒度相似度估算 |
| analysis_task_id | VARCHAR(64) | 关联任务（可空） |
| status | ENUM | `uploaded` / `linked` / `analyzed` / `expired` |
| created_at / updated_at | TIMESTAMP | 自动维护 |

### 6.3 规划中
1. `export_files`
   - id、task_id、type(json/xmp/jsx)、file_path/url、created_at。
2. `users`
   - id、email/username、avatar_url、created_at。

---

## 7. Prompt 规范（摘要）

### 7.1 Part1 Prompt 要点
- 角色：资深摄影师 + 构图指导教师。
- 分段输出：
  1. 自然语言报告（专业点评、构图、光影、工作流草案）。
  2. JSON：`professional_evaluation`、`composition`（含 `advanced_sections` 七段）、`lighting`、`analysis_meta`、`workflow_draft`。
- 约束：
  - 禁止臆造，信息不足时标明“不确定”。
  - 构图七段使用严格标题。
  - 输出中文。

### 7.2 Part2 Prompt 要点
- 角色：摄影调色指导。
- 输入：Part1 摘要 + `workflow_draft`（JSON）+ 源/目标图。
- 输出：
  - 自然语言执行报告（含草案对齐说明）。
  - JSON：`color_scheme`、`lightroom`（全量范围）、`lightroom_local_adjustments`、`lightroom_panels`、`photoshop`（曲线/蒙版/步骤等）、`workflow_steps`、`workflow_alignment_notes`。
- 约束：
  - 所有数值需字符串形式，保留正负号；曲线点提供数组。
  - 必须说明“沿用 / 调整 / 新增”原因。
  - 若 Part1 should_stop，返回提示并终止。

---

## 8. 关键非功能要求
- **日志**：所有 Gemini 调用必须记录耗时、阶段、缺失字段；错误保存原始返回片段（避免泄露图片数据）。
- **代理**：默认读取 `HTTPS_PROXY`，如果设置则全局覆盖 fetch。
- **安全**：上传限 25MB；未来接入对象存储时需 MIME 校验与防注入。
- **扩展性**：设计上允许替换 LLM（Claude / GPT-4），保持 Prompt 模块化。
- **注释规范**：后端新增代码必须包含中文注释，解释用途与边界。

---

## 9. 迭代路线图（后端最小改动）
1. **结构化输出补强（已完成）**：完善 Prompt + 解析兜底 + 日志。
2. **查询接口（阶段一完成）**：已实现单任务查询，历史列表待上线。
3. **上传链路（已完成）**：`/api/photos/upload` + `uploads` 表（临时 Base64 + 相似度）。
4. **用户模块**：头像上传与基础资料（若业务需要）。
5. **缓存与性能**：接入 Redis（可选），启用结果缓存、命中日志。
6. **对象存储**：将 Base64 替换为 URL、批量迁移（长期目标）。

---

## 10. 参考资料
- 《BACKEND_DEVELOPER_GUIDE.md》：上传接口、缓存、API 细节、性能优化建议。
- Gemini 官方文档：https://ai.google.dev/docs
- 现有代码库：`server/src/services` / `src/utils/dataConverter.ts`

> 本文同步至版本控制，请后续迭代按章节更新。
