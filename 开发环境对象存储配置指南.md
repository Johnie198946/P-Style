# 开发环境对象存储配置指南

## 一、概述

开发环境下，对象存储有三种配置方式：

1. **local（本地文件系统）** - 默认方式，无需额外配置
2. **minio（MinIO）** - S3 兼容的对象存储，适合开发环境
3. **aliyun_oss（阿里云 OSS）** - 生产环境使用，开发环境不推荐

---

## 二、配置方式

### 2.1 方式一：local（本地文件系统）- 推荐用于快速开发

**特点**：
- ✅ 无需额外安装和配置
- ✅ 开箱即用
- ✅ 图片存储在 `server_py/storage/` 目录下
- ⚠️ 图片以 Base64 格式存储在数据库中（兼容模式）

**配置方法**：
1. 在 `server_py/.env` 文件中设置（或不设置，默认就是 local）：
   ```bash
   OSS_STORAGE_TYPE=local
   ```

2. 或者不设置任何对象存储相关环境变量，系统默认使用 `local` 模式

**存储位置**：
- 图片文件：`server_py/storage/` 目录
- 数据库：Base64 格式存储在 `uploads.source_image_data` 和 `uploads.target_image_url` 字段

**优点**：
- 无需安装 Docker 或 MinIO
- 适合快速开发和测试
- 不会因为对象存储连接失败导致上传超时

**缺点**：
- 数据库体积会快速增长（Base64 存储）
- 无法 CDN 加速
- 不适合生产环境

---

### 2.2 方式二：minio（MinIO）- 推荐用于完整开发环境

**特点**：
- ✅ S3 兼容的对象存储
- ✅ 可以模拟生产环境
- ✅ 图片存储在 MinIO 服务器，数据库只存储 URL
- ✅ 支持 Docker 快速部署

**配置步骤**：

#### 步骤 1：安装 MinIO（使用 Docker）

```bash
# 启动 MinIO 容器
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  minio/minio server /data --console-address ":9001"
```

**说明**：
- `9000` 端口：MinIO API 端口（用于上传/下载）
- `9001` 端口：MinIO 控制台端口（用于管理界面）
- 默认用户名：`minioadmin`
- 默认密码：`minioadmin`

#### 步骤 2：访问 MinIO 控制台

打开浏览器访问：`http://localhost:9001`

使用默认账号登录：
- 用户名：`minioadmin`
- 密码：`minioadmin`

#### 步骤 3：安装 Python MinIO 客户端

```bash
# 在 server_py 目录下
pip install minio
```

**注意**：`requirements.txt` 中已包含 `minio>=7.2.0`，如果已安装依赖则无需单独安装。

#### 步骤 4：配置环境变量

在 `server_py/.env` 文件中添加：

```bash
# 对象存储配置
OSS_STORAGE_TYPE=minio
OSS_ENDPOINT=http://localhost:9000
OSS_ACCESS_KEY_ID=minioadmin
OSS_ACCESS_KEY_SECRET=minioadmin
OSS_BUCKET_NAME=photostyle
```

**配置说明**：
- `OSS_STORAGE_TYPE=minio` - 使用 MinIO 存储
- `OSS_ENDPOINT=http://localhost:9000` - MinIO API 地址
- `OSS_ACCESS_KEY_ID=minioadmin` - MinIO 访问密钥 ID（默认）
- `OSS_ACCESS_KEY_SECRET=minioadmin` - MinIO 访问密钥（默认）
- `OSS_BUCKET_NAME=photostyle` - 存储桶名称（会自动创建）

#### 步骤 5：重启后端服务

```bash
# 停止当前后端服务（如果有）
# 然后重新启动
cd server_py
python run.py
```

**验证**：
- 查看后端启动日志，应该看到：
  ```
  MinIO 客户端初始化成功: localhost:9000
  ```
- 如果看到错误，检查 MinIO 容器是否正常运行：
  ```bash
  docker ps | grep minio
  ```

**存储位置**：
- 图片文件：MinIO 服务器（`/data` 目录，在 Docker 容器内）
- 数据库：URL 存储在 `uploads.source_image_url` 和 `uploads.target_image_url` 字段

**优点**：
- 可以模拟生产环境
- 数据库体积小（只存储 URL）
- 支持 CDN 加速（如果配置了）
- 图片管理方便（通过 MinIO 控制台）

**缺点**：
- 需要安装 Docker 和 MinIO
- 如果 MinIO 连接失败，会等待 10 秒超时（已优化，会自动回退到 Base64）

---

### 2.3 方式三：aliyun_oss（阿里云 OSS）- 不推荐用于开发环境

**特点**：
- ⚠️ 需要阿里云账号和 AccessKey
- ⚠️ 会产生费用（虽然很少）
- ⚠️ 开发环境不推荐使用

**配置方法**（仅作参考，不推荐）：

1. 在阿里云控制台创建 OSS Bucket
2. 获取 AccessKey ID 和 AccessKey Secret
3. 在 `server_py/.env` 文件中配置：
   ```bash
   OSS_STORAGE_TYPE=aliyun_oss
   OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com
   OSS_ACCESS_KEY_ID=your_access_key_id
   OSS_ACCESS_KEY_SECRET=your_access_key_secret
   OSS_BUCKET_NAME=photostyle
   ```

---

## 三、当前默认配置

根据代码配置（`server_py/app/config.py`）：

```python
OSS_STORAGE_TYPE: str = "local"  # 默认使用本地文件系统
```

**这意味着**：
- 如果不配置任何环境变量，系统默认使用 `local` 模式
- 图片会以 Base64 格式存储在数据库中
- 同时也会保存到 `server_py/storage/` 目录（本地文件系统）

---

## 四、优化说明

根据最新的代码优化（`server_py/app/routes/upload.py`）：

**如果对象存储类型是 "local" 或未配置**：
- ✅ 直接使用 Base64 存储，不尝试连接对象存储
- ✅ 避免不必要的连接尝试和超时等待
- ✅ 防止前端请求超时或被取消

**如果对象存储类型是 "minio" 或 "aliyun_oss"**：
- ✅ 尝试上传到对象存储
- ✅ 如果连接失败或超时，自动回退到 Base64 存储
- ✅ 不会因为对象存储问题导致上传失败

---

## 五、推荐配置

### 5.1 快速开发（推荐）

**使用 local 模式**：
- 无需配置，开箱即用
- 适合快速开发和测试
- 不会因为对象存储连接问题导致上传失败

**配置**：
```bash
# server_py/.env（或不设置，使用默认值）
OSS_STORAGE_TYPE=local
```

### 5.2 完整开发环境（推荐）

**使用 MinIO**：
- 可以模拟生产环境
- 数据库体积小
- 图片管理方便

**配置**：
```bash
# server_py/.env
OSS_STORAGE_TYPE=minio
OSS_ENDPOINT=http://localhost:9000
OSS_ACCESS_KEY_ID=minioadmin
OSS_ACCESS_KEY_SECRET=minioadmin
OSS_BUCKET_NAME=photostyle
```

**启动 MinIO**：
```bash
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  minio/minio server /data --console-address ":9001"
```

---

## 六、常见问题

### 6.1 MinIO 连接失败

**问题**：后端日志显示 "MinIO 初始化失败"

**解决方案**：
1. 检查 MinIO 容器是否运行：
   ```bash
   docker ps | grep minio
   ```
2. 如果容器未运行，启动容器：
   ```bash
   docker start minio
   ```
3. 如果容器不存在，重新创建（见步骤 1）
4. 检查端口是否被占用：
   ```bash
   lsof -i :9000
   lsof -i :9001
   ```

### 6.2 上传超时

**问题**：上传图片时出现"请求已取消"错误

**原因**：
- MinIO 连接失败，等待 10 秒超时
- 前端请求超时或被取消

**解决方案**：
1. **临时方案**：切换到 `local` 模式（不尝试连接 MinIO）
   ```bash
   OSS_STORAGE_TYPE=local
   ```
2. **根本方案**：修复 MinIO 连接问题（见 6.1）

### 6.3 存储桶不存在

**问题**：MinIO 初始化时提示存储桶不存在

**说明**：
- 代码会自动创建存储桶（`photostyle`），无需手动创建
- 如果自动创建失败，检查 MinIO 权限配置

---

## 七、验证配置

### 7.1 检查当前配置

查看后端启动日志，应该看到：

**local 模式**：
```
本地文件系统存储初始化: /path/to/server_py/storage
```

**minio 模式**：
```
MinIO 客户端初始化成功: localhost:9000
创建 MinIO 存储桶: photostyle
```

### 7.2 测试上传

1. 启动后端服务
2. 在前端上传一张图片
3. 查看后端日志，应该看到：
   ```
   [上传接口] 收到上传请求...
   [上传接口] 用户认证成功...
   [上传接口] 开始读取源图数据...
   [上传接口] 对象存储类型为 local 或未配置，直接使用 Base64 存储
   [上传接口] 源图 Base64 编码完成...
   [上传接口] 上传成功，准备返回响应...
   ```

---

## 八、总结

**开发环境推荐配置**：

1. **快速开发**：使用 `local` 模式（默认，无需配置）
2. **完整开发**：使用 `minio` 模式（需要 Docker）

**配置优先级**：
1. 环境变量（`.env` 文件）
2. 默认值（`local`）

**注意事项**：
- 如果对象存储未配置或连接失败，系统会自动回退到 Base64 存储
- 不会因为对象存储问题导致上传失败
- 所有关键步骤都有日志记录，便于排查问题

