# 🧠 QuantaNova PhotoStyle Clone - 顶层设计文档 V4.2

> 本文为 2025-11-15 版本，聚焦"最小改动迭代"策略，整理前后端全部有效规范。所有未列出的旧约定视为废弃。
> 
> **V4.1 更新**：新增风格模拟功能章节，基于 Part1 和 Part2 分析结果生成风格迁移后的图片。
> 
> **V4.2 更新**：新增复刻可行性评估系统，在Part1分析前进行快速可行性评估，通过模态框即时提示用户。

---

## 1. 项目总览

### 1.1 产品定位
- **核心价值**：解析摄影作品风格 → 生成专业化 Lightroom / Photoshop 参数与工作流。
- **关键特性**：两阶段分析（Part1 草案 / Part2 执行）、结构化输出、专业构图七段分析、可导出文件。

### 1.2 用户旅程
```
上传源图（必填）+ 目标图（选填）
    ↓
复刻可行性评估（新增，自动触发）
  • 快速评估两张图片的复刻可行性
  • 8个维度量化指标（光线、色彩、语义、构图等）
  • 检测致命不兼容因子（deal-breakers）
  • 生成综合评分、难度等级、置信度
  • 提供推荐改进方案
  • 通过模态框即时提示用户
    ↓
用户选择：
  - 继续分析（接受风险）
  - 按建议调整并重新上传
  - 更换目标图
    ↓
阶段一 / Part1（基础洞察，自动触发）
  • 专业摄影点评
  • 构图分析（七大板块）
  • 光影参数
  • 色彩基调 & 风格提示
  • 工作流思路草案（Lightroom / Photoshop / 其它）
    ↓
阶段二 / Part2（用户按需触发执行类卡片时调用）
  • 色彩方案（含曲线、调色思路）
  • Lightroom 详细参数（全面板 + 局部调整）
  • Photoshop 步骤（曲线、选择性色、蒙版、技巧说明）
  • 工作流对齐说明（沿用 / 调整 / 新增）
    ↓
风格模拟（用户按需触发）
  • 基于 Part1 和 Part2 的分析结果
  • 使用 Gemini 2.5 flash-image 生成风格迁移后的图片
  • 去水印处理（SynthID 水印）
  • 前后对比展示
    ↓
交付
  ✓ 自然语言报告
  ✓ JSON 结果（结构化）
  ✓ XMP / JSX 导出
  ✓ 参数复制、手动校准提示
  ✓ 风格模拟效果图（可选）
  ✓ 可行性评估结果（可选）
```

### 1.3 目标用户
- 摄影师 / 后期修图师：批量复刻风格、规范流程。
- 摄影教育人士：教学范例与讲解材料。
- 摄影爱好者：学习专业调色与构图语言。

---

## 2. 技术架构

### 2.1 全局架构概览
```
┌──────────────── 前端 (React + Vite + TS) ────────────────┐
│ 上传组件 / Loading / 结果展示 / API 封装 / 数据转换 / UI │
└────────────────────────────────────────────────────┘
                              │REST API
┌─────────────────────────── 后端 (Node.js + Express) ───────┐
│ 路由层 → 服务层（Gemini / 映射 / 导出）→ 数据访问层 → 日志 │
└────────────────────────────────────────────────────┘
                              │
┌─────────────────────────── 数据层 (MySQL) ────────────────┐
│ analysis_tasks / uploads / export_files / users (规划)     │
└────────────────────────────────────────────────────┘
                              │
┌─────────────────────────── 外部服务 ───────────────────────┐
│ Gemini Vision API / 代理 (ClashX) / 对象存储(规划) / Redis │
└────────────────────────────────────────────────────┘
```

### 2.2 运行环境
| 组件         | 端口 / 说明                   |
|--------------|------------------------------|
| 前端 Vite    | http://localhost:3001        |
| 后端 Express | http://localhost:8081        |
| MySQL (Docker)| localhost:3309               |
| 代理 (ClashX)| http://127.0.0.1:7890        |

---

## 3. 功能模块定义

### 3.1 前端模块
| 模块 | 文件 | 说明 |
|------|------|------|
| 图片上传 | `src/components/PhotoUploadZone.tsx` | 拖拽/点击上传、磁吸动画、Base64 预览、格式校验 |
| 可行性评估模态框 | `src/components/FeasibilityModal.tsx` | 复刻可行性评估结果展示、推荐方案、用户选择（继续/重试） |
| 分析进度 | `src/App.tsx` Loading 区域 | Part1/Part2 状态、全屏虚化、失败重试提示 |
| 结果展示 | `src/components/AdjustmentResults.tsx` | 多卡片呈现点评/构图/光影/色彩/LR/PS、导出、复制功能 |
| 构图分析卡片 | `src/components/sections/CompositionSection.tsx` | 七大板块 UI（画面主结构~构图风格建议），统一样式 |
| 光影、色彩、LR/PS 分析 | `src/components/sections/*.tsx` | 参数分段、曲线渲染、hover 提示、图片对比 Modal |
| 风格模拟 | `src/components/StyleSimulation.tsx` | 风格迁移效果展示、前后对比滑块、下载/分享功能 |
| API 封装 | `src/lib/api.ts` | `/api/analyze/feasibility`、`/part1`、`/part2`、`/api/simulate/style`、导出接口等 |
| 数据转换 | `src/lib/analysisAdapter.ts` | Gemini → 前端结构、自然语言兜底解析、构图七段提取 |

#### 3.1.1 复刻可行性在“照片点评/Lightroom”内的嵌入（新增）
- 数据来源：`analysis_tasks.feasibility_result`（见第6章数据模型）
- 页面数据流：
  1) 结果页载入时，前端通过 `GET /api/analyze/:taskId` 获取 `task`；  
  2) 从 `task.feasibility_result` 读取结论与依据；  
  3) 传递给两处组件：
     - `ReviewSection`：通过 prop `data.feasibility`、`data.feasibilityDescription` 渲染“复刻可行性评估”信息块（结论/难度/信心/限制因素/建议/备注）。
     - `LightroomSection`：通过 prop `conversionData` 渲染“调色思路”卡片（可行性徽章、限制因素、建议清单、跨段落摘要）。  
  4) 若 `feasibility_result` 缺失，则两处模块自动隐藏，不影响其它内容。
- 字段映射：
  - `feasibility_result.feasibilityScore → 百分比圆环/评分条（可选）`
  - `difficulty → 难度徽章`
  - `confidence → 置信度徽章（0~1 映射为 0%~100%）`
  - `dealBreakers[] → “不可复刻”高亮提示`
  - `dominantFactors[] → Top-3 拖累因子（名称/原因）`
  - `recommendedActions[] → 建议清单（action/why/priority）`
  - `explanation → 简要说明段落`
  - `metrics.{L,C,S,P,D,T,Q,R} → 高级视图（可选：开发中/关闭状态）`

### 3.2 后端模块
| 层级 | 文件 | 职责 |
|------|------|------|
| 路由层 | `src/routes/analyzeRoutes.js` | `/api/analyze/feasibility`、`/part1`、`/part2`、`/`(combined) |
| 路由层 | `src/routes/uploadRoutes.js` | `/api/photos/upload`，记录上传与相似度 |
| 路由层 | `src/routes/simulateRoutes.js` | `/api/simulate/style`，风格模拟接口 |
| 服务层 | `src/services/feasibilityService.js` | 复刻可行性评估服务：8个维度指标计算、deal-breaker检测、综合评分、推荐方案生成 |
| 服务层 | `src/services/analyzeService.js` | 图片 DataURL、元数据提取、Gemini 调用、任务落库 |
| 服务层 | `src/services/analysisFormatter.js` | Gemini 输出标准化映射、缺失段落告警 |
| 服务层 | `src/services/uploadService.js` | `uploads` 表存取、任务关联 |
| 服务层 | `src/services/styleSimulationService.js` | 风格模拟服务：cachedContent 管理、模板填充、Gemini 2.5 flash-image 调用、去水印处理 |
| Prompt 模板 | `src/services/promptTemplate.js` | Part1/Part2 Prompt、上下文拼接、输出格式要求 |
| Gemini 调度 | `src/services/geminiService.js` | 代理配置、重试、超时、响应解析、日志，使用 `@google/genai` 官方 SDK，默认模型 `gemini-2.5-pro`，风格模拟使用 `gemini-2.5-flash-image` |
| 色彩映射 | `src/services/colorMappingService.js` | Gemini 结果到 Lightroom/Photoshop 参数的二次结构化 |
| 导出服务 | `src/services/exportService.js` | XMP/JSX/JSON 文件生成 |
| 任务存储 | `src/services/taskService.js` | `analysis_tasks` CURD（JSON 字段 JSON.stringify，包含 `feasibility_result`） |
| 配置 | `src/config/env.js`、`appConfig.js` | 环境变量加载、超时/重试配置 |
| 工具 | `src/utils/*` | 文件→DataURL、EXIF 提取、async 队列、日志等 |

> Gemini 配置：通过 `@google/genai` 的 `GoogleGenAI` 客户端调用官方 Gemini API，`ENV.GEMINI_MODEL` 默认使用 `gemini-2.5-pro`，可通过环境变量覆盖。代理仍由 `ProxyAgent` 注入全局 `fetch`，重试与超时逻辑保持不变。

#### 3.2.1 Token 优化与上下文策略（2025-11 更新）
- **评估结论**：两阶段分析均以独立 REST 请求运行，优先使用 **长上下文 + 缓存 Prompt 常量**；多轮会话模式因需维护 session/重传图片而暂不采纳。
- **实施要点**：
  1. 启动或首次调用时，使用 `@google/genai` 的 `caches.create()` 将 Step1~Step6 的固定指令写入缓存，`TTL` 默认 `GEMINI_PROMPT_CACHE_TTL_SECONDS=43200` 秒；
  2. 后续分析请求仅传递动态上下文（图片、EXIF、Stage1 摘要等），并携带 `cachedContent` id；
  3. 缓存失效时自动重建，日志记录命中情况，便于在后台统计 token 节省。
- **多轮会话不采用的原因**：任务常以 Job 模式执行，维护会话状态与图片重复上传成本高，收益有限。
- **扩展方向**：如需在调试页提供连续追问，可在前端独立实现 Chat 模式，再评估多轮对话；主流程继续走缓存方案即可。

#### 3.2.2 分析输出协议与后端流程（2025-11 更新）
- **接口契约**
  - `POST /api/analyze/part1`：`FormData` 携带 `sourceImage`（必填）与 `targetImage`（可选），返回 `{ taskId, stage, status, analysis, structuredAnalysis, naturalLanguage, similarityCheck, protocolVersion, rawText }`。
  - `POST /api/analyze/part2`：`FormData` 携带 `taskId`（必填，可附带源/目标图以更新），返回结构同上，`stage=part2`。
  - Prompt 模板明确：只要本次请求含 `user_image`，严禁输出 “no user_image provided”。
- **Gemini 调度**：`geminiService` 负责代理、Prompt 缓存、重试与 JSON 清理，返回结果统一落库，同时在 `analysis_meta.image_info` 中写入源/目标图 EXIF。
- **协议解析**：`analysisFormatter` 基于 `protocolVersion=2025-02` 将模型输出映射到统一结构，并在缺失字段时补默认值、写入 `meta.warnings`。
- **前端适配**：`analysisAdapter` 将 `structured.sections.*` 转为 `mappedResults`（review/composition/...），供结果页与各 Section 使用；原始 `sections` 及 `meta.rawNaturalLanguage` 透传用于调试、导出。
- **阶段切换**：前端维护 `analysisStage`（`stage1` → `loading` → `stage2`），基础分析后展示 Stage1 卡片，触发 “查看详细方案” 时请求 Part2，完成后展开 Stage2 卡片；如需调试页，可读取 `analysisResult.naturalLanguage` 与 `mappedResults.sections`。

### 3.3 风格模拟功能（新增）

#### 3.3.1 功能概述
- **定位**：基于 Part1 和 Part2 的分析结果，使用 Gemini 2.5 flash-image 生成风格迁移后的图片
- **触发时机**：用户点击"风格模拟"按钮（需先完成 Part1 和 Part2 分析）
- **核心特性**：
  - 利用长上下文机制，Gemini 已记住 Part1 和 Part2 的输出，无需重复上传
  - 使用 `cachedContent` 机制缓存固定指令模板，只传递图片尺寸信息
  - 自动去水印处理（SynthID 水印）
  - 前后对比展示（滑块交互）

#### 3.3.2 技术实现
- **模型**：`gemini-2.5-flash-image`（图片生成专用）
- **长上下文利用**：
  - Gemini 2.5 flash-image 支持 100 万个词元的上下文窗口
  - 可以记住之前的所有交互内容，包括 Part1 和 Part2 的输出
  - 风格模拟时只需要传递 prompt 模板，Gemini 会自动调研已记住的分析结果
- **cachedContent 机制**：
  - 固定指令模板作为 `cachedContent` 缓存（TTL: 12小时）
  - 动态部分只包含图片尺寸信息（用户图宽高比、输出分辨率）
  - 大幅减少 token 消耗
- **固定指令模板**：
  - 让 Gemini 调研 Part1 和 Part2 中"照片点评"、"构图分析"、"光影参数"、"色彩方案"、"lightroom"、"photoshop"的输出
  - 明确要求：只进行如 Lightroom 和 Photoshop 的功能调整，不许增加额外元素
  - 必须按照参考图的色调风格和调色方案调整，不许进行发散
- **图片处理**：
  - 直接使用原始图片，不进行压缩
  - 根据用户图宽高比选择输出比例（1:1, 4:3, 16:9 等）
  - 去水印处理（使用 sharp 库进行基础去水印）

#### 3.3.3 前端实现
- **组件**：`src/components/StyleSimulation.tsx`
- **功能**：
  - 加载状态展示
  - 前后对比滑块（可拖拽）
  - 下载/分享按钮
  - 错误提示
- **API 调用**：`src/lib/api.ts` 中的 `simulateStyle(taskId)` 函数
- **调用位置**：`ThemeCardsGrid.tsx` 和 `ResultsPage.tsx`，传递 `taskId`

#### 3.3.4 后端实现
- **路由**：`POST /api/simulate/style`
- **服务**：`server/src/services/styleSimulationService.js`
- **流程**：
  1. 获取任务数据（从 `analysis_tasks` 表）
  2. 提取图片和尺寸信息
  3. 填充指令模板（仅图片尺寸信息）
  4. 调用 Gemini 2.5 flash-image API（使用 cachedContent + 长上下文）
  5. 去水印处理
  6. 返回结果（原图 + 处理后的图片）

#### 3.3.5 数据模型
- **输入**：`taskId`（与 Part1 和 Part2 为同一个任务 ID）
- **输出**：
  - `originalImage`：原图（Base64）
  - `processedImage`：处理后的图片（Base64）
  - `stylePrompt`：填充后的风格迁移指令（用于调试）
  - `processingTime`：处理耗时（毫秒）

#### 3.3.6 错误处理
- 任务不存在：返回 404
- 分析结果不完整：返回 400，提示需要先完成 Part1 和 Part2 分析
- Gemini API 调用失败：返回 500，提示"风格模拟服务暂时不可用"
- 去水印失败：返回带水印的图片，前端提示"水印移除失败"

### 3.4 Gemini 输出协议（2025-02）
- **整体思路**：模型输出必须同时包含自然语言段落与结构化 JSON，后端按协议解析、补缺并记录 `warnings`，前端依赖统一结构渲染。
- **顶层结构**：
  ```json
  {
    "protocolVersion": "2025-02",
    "stage": "part1 | part2",
    "meta": {
      "taskId": "uuid",
      "sourceImage": {...},
      "targetImage": {...},
      "similarityCheck": {...} | null,
      "warnings": ["string"],
      "rawNaturalLanguage": "string"
    },
    "sections": {
      "photoReview": {...},
      "composition": {...},
      "lighting": {...},
      "color": {...},
      "lightroom": {...},
      "photoshop": {...}
    }
  }
  ```
- **Section 结构**：每个模块包含 `naturalLanguage`（键→段落数组）与 `structured`（前端绘制数据）。示例：
  ```json
  "photoReview": {
    "naturalLanguage": {
      "summary": ["整体风格描述"],
      "highlights": ["亮点段落"],
      "technique": ["设备/镜头/拍摄技术"],
      "comparison": ["源图 vs 用户图分析"]
    },
    "structured": {
      "overview": { "summary": "一句话", "toneKeywords": ["纪实","怀旧"] },
      "strengths": [{ "id": "strength-1", "title": "主体突出", "description": "...", "evidence": ["细节"] }],
      "technicalInsights": [{ "category": "设备推测", "detail": "...", "confidence": "medium" }],
      "parameterComparison": [{ "item": "曝光", "source": "偏低", "target": "正常", "adjustment": "压 0.3EV" }]
    }
  }
  ```
- **模块关键字段**：
  - `composition`：`naturalLanguage` 包含 `framework/subjectWeight/leadingLines/spaceLayers/proportion/balanceDynamics`；`structured` 内各自提供 `summary + keyPoints`，`balanceDynamics` 另含 `styleCategory`、`improvement[]`。
  - `lighting`：`exposureControl/toneCurve/textureClarity` 对应段落；结构化部分要求滑块值为字符串（含 ±），tone curve 5 个控制点，RGB 曲线≥4 点，均附 `explanation`。
  - `color`：`styleKey/whiteBalance/colorGrading/hslAdjustments`；结构化中包含关键词、温度/色调、分级三通道、HSL 八色数组（枚举 `red/orange/yellow/green/aqua/blue/purple/magenta`）。
  - `lightroom`（Stage2）：`panelSummary/localAdjustments` 自然语言；`structured.panels` 固定 `basic/detail/color/hsl/colorGrading` 五类，附 `toneCurve`、`colorGrading`、`localAdjustments`（相对坐标、参数列表）。
  - `photoshop`（Stage2）：自然语言键 `cameraRaw/colorGrading/gradientMap/localAdjustments/finalPolish`；结构化输出 Camera Raw 参数、分级、渐变映射（`enabled` + `points` 0-100）、局部调整、最终优化步骤。
- **数值与格式约束**：
  - 所有调整值为字符串，强制带符号（如 `"+0.30"`、`"-25"`、`"+0"`）。
  - 曲线控制点使用整数坐标，缺失时后端补齐默认 `[[0,0],[64,64],[128,128],[192,192],[255,255]]` 并记录 warning。
  - HSL、局部调整、渐变映射等字段缺失时返回空数组 `[]`，不得输出“无/NA”。
- **Prompt 约束**：在 Part1/Part2 模板末尾明确 JSON skeleton、字段名称、数组上限，禁止新增字段；自然语言必须写入各自 `naturalLanguage` 键，额外解释不可脱离协议。
- **后端处理**：`analysisFormatter` 按 schema 校验补缺，将解析前原文写入 `meta.rawNaturalLanguage`，异常写入 `meta.warnings`；老数据（无 `protocolVersion`）走兼容路径。
- **前端适配**：`analysisAdapter` 根据 `protocolVersion` 读取 `sections.*`，自然语言直接渲染段落，结构化映射到卡片/表格/曲线；`meta.warnings` 用于 UI 提示或日志。
- **前端展示规范（2025-11 更新）**：`DebugAnalysisPage` / `ResultsPage` 优先呈现 Gemini 原文段落，再附结构化卡片；每个模块均包含
  - 「阶段原文概述」：`meta.rawNaturalLanguage` 原汁原味展示（保持“资深老炮”语气）。
  - 「Natural Language Blocks」：按 `naturalLanguage` 键映射中文标题（如 `overview` → “整体概览”），多段落逐条输出。
  - 「Narrative Blocks」：`structured.*.narratives` 中的长文说明以引用卡片呈现。
  - 「JSON Data」：使用 `JsonBlock` 折叠显示 `structured` 原始 JSON，支持复制。
  - 所有模块新增 `sections` 透传，便于调试页/弹窗/导出工具共享同一数据源。

### 3.3 管理后台（Admin Control Center）
| 模块 | 前端文件 | 后端职责 |
|------|----------|----------|
| 管理员登录 | `src/components/admin/AdminLoginDialog.tsx`、`/AdminPage.tsx` | `/api/admin/auth/login`、`/auth/me`，基于 JWT + `role=admin` |
| Dashboard | `admin/Dashboard.tsx` | `/api/admin/dashboard/metrics` 汇总用户、订阅、支付、任务、流量等指标 |
| 用户管理 | `admin/UsersManagement.tsx` | `/api/admin/users`（分页、搜索、禁用、重置密码、查看订阅/任务） |
| 订阅管理 | `admin/SubscriptionsManagement.tsx`、`PlanEditor.tsx` | `/api/admin/plans`、`/api/admin/subscriptions`，管理套餐、订阅状态 |
| 支付管理 | `admin/PaymentsManagement.tsx` | `/api/admin/payments`、退款预留接口，跟踪线上支付 |
| 资源用量 | `admin/UsageManagement.tsx` | `/api/admin/usage/*`，展示分析任务耗时与资源消耗 |
| 任务管理 | `admin/TasksManagement.tsx` | `/api/admin/tasks`（列表、重试、终止、查看日志） |
| 内容管理 | `admin/ContentManagement.tsx`、`ContentEditor.tsx` | `/api/admin/content`，管理订阅页/系统公告等 CMS 区块 |
| 数据分析 | `admin/Analytics.tsx` | `/api/admin/analytics/*`，展示转化、留存、支付漏斗数据 |
| 审计日志 | 待开发 | `/api/admin/audits`，记录所有管理员操作 |

> 管理后台的所有接口均需 `requireAdmin`，并写入 `audit_logs`。

### 3.5 帐号与权限体系
- **身份模型**：`users` 表存储所有账号，`role` 字段区分 `user` 与 `admin`（预留扩展角色），账号状态由 `status` 控制；展示信息使用 `display_name`、`avatar_url`，审计字段 `created_by`/`updated_by` 用于追踪操作人。
- **凭证存储**：`auth_tokens` 统一管理所有令牌。`type=session` 为主站登录，`type=admin_session` 为后台登录，`email_otp`/`phone_otp`/`alipay_pending` 用于验证码与第三方登录，`admin_mfa` 作为管理员二次验证令牌。成功登录后由 `createSession()` 写入记录并返回 JWT，退出时通过 `logoutSession()` 将令牌标记 `consumed=1`。
- **访问控制**：
  - 主站接口默认接受 `session` 令牌，业务内部自行校验资源所属用户。
  - 管理后台接口全部挂载 `/api/admin/**`，中间件 `requireAdmin` 会校验 Bearer Token 是否为 `admin_session` 且 `role=admin`，随后通过 `requirePermissions` 校验具体功能权限。
  - 后续若需要更细粒度控制，可在此基础上新增角色-权限映射或策略表（`roles`、`role_permissions`、`user_roles` 已落地，可支持一人多角色）。
- **管理员登录流程**：前端按 `Ctrl/⌘ + Shift + A` 唤出登录框，输入管理员账号（邮箱/显示名/ID）+密码 → 触发后台校验 → 发送邮箱验证码（二次验证）→ 验证通过后返回 `admin_session`，浏览器保存到 `localStorage.adminAuthToken` 并切换后台页面。
- **审计机制**：核心后台操作（登录、登出、角色调整、创建/修改/删除用户、内容、订阅、任务等）统一调用 `recordAuditLog()`，向 `audit_logs` 写入 `admin_id`、动作、目标对象、前后状态、IP、User-Agent；登录/失败记录落在 `login_attempts` 表，用于安全审计。
- **安全增强**：管理员连续密码错误达到 `AUTH_ADMIN_MAX_FAILED_ATTEMPTS` 次会锁定 `AUTH_ADMIN_LOCK_MIN` 分钟；二次验证有效期 `AUTH_ADMIN_MFA_EXPIRES_MIN` 分钟，错误次数达到 `AUTH_ADMIN_MFA_MAX_ATTEMPTS` 将作废，需要重新登录获取验证码。
- **前端约定**：后台菜单根据 `permissions` 动态渲染；角色管理页允许新增/编辑角色以及批量分配权限，用户管理页支持查看/分配角色。
- **安全增强规划**：后续可继续加入短信/Authenticator 双因子、操作审批流程、异常登录告警等。

### 3.6 安全日志与告警（规划中）
- 现已落地 `login_attempts` 表记录成功/失败登录行为，后续可在审计中心展示，并结合阈值触发告警。
- 管理后台将新增“审计日志/告警”页面，展示关键操作与安全事件，支持导出与筛选（阶段 C）。

### 3.4 规划中模块（待迭代实现）
| 模块 | 前端状态 | 后端计划 |
|------|----------|----------|
| 审计中心 | ❌ | `/api/admin/audits`（分页、筛选、导出） |
| 操作告警 | ❌ | 接入站内通知/邮件，异常登录、资源用量暴增提醒 |
| 批量导入 | ❌ | 支持 CSV 批量创建用户、套餐、内容 |
| 权限细粒度 | ❌ | `roles` / `role_permissions` 表，支持运营 / 财务等角色 |
| 运营看板 | ❌ | 数据对标、留存漏斗、分渠道报表 |

---

## 4. 两阶段分析逻辑

### 4.1 阶段一（Part1）
- **触发**：用户点击“开始 AI 分析”。
- **输出**：
  - 专业摄影点评（自然语言 + `professional_evaluation` JSON）
  - 构图七段分析 (`composition.advanced_sections` 七条必填)
  - 光影参数 (`lighting`：趋势 / key handles / 纹理 / 后期动作)
  - 色彩基调与可行性 (`analysis_meta.conversion_feasibility` 等)
  - 工作流草案 (`workflow_draft`：阶段名、目标、关键动作、风险、alignment)
- **上下文存储**：源/目标图 Base64、EXIF、Part1 自然语言、草案、taskId 全部写入 `analysis_tasks`。

### 4.2 阶段二（Part2）
- **触发**：前端点击“色彩方案 / Lightroom / Photoshop”卡片，且 `stage2Ready` 为 false。
- **输入上下文**：Part1 保存的 `workflow_draft`、`part1_summary`、源/目标图 DataURL。
- **输出**：
  - 色彩方案（RGB 曲线、调色思路、`color_mapping`）
  - Lightroom 参数（基础面板、HSL、Color Grading、细节、局部调整、调色思路）
  - Photoshop 步骤（曲线四通道、选择性色、色彩平衡、蒙版、Camera Raw 等）
  - 工作流执行总结 (`workflow_final`、`workflow_alignment_notes`)
- **缓存策略**：成功后 `analysis_tasks.part2_completed=1`，以后点击直接读取。

### 4.3 Combined 模式
- **用途**：一次性完成 Part1 + Part2（调试或批量生成时使用）。
- **行为**：同 Part1/Part2，统一保存结构；前端默认不调用。

### 4.4 结构化结果映射
- **分析阶段**：Part1/Part2/Combined 全部在服务层调用 `analysisFormatter`。
- **输出内容**：`review`、`composition`、`lighting`、`color`、`workflow`、`execution`、`meta` 六大块。
- **落库策略**：`analysis_tasks.structured_result` 保存规范对象；若旧任务缺失该字段，查询接口会即时重新映射。
- **质量监控**：当构图七段缺失内容时，自动写入日志 `warn` 并在 `meta.notes` 登记问题，供前端提示。

---

## 5. API 设计（当前 + 规划）

### 5.1 已实现
| Method | Endpoint | 描述 |
|--------|----------|------|
| POST | `/api/analyze/feasibility` | 复刻可行性评估，在Part1前快速评估两张图片的复刻可行性，返回评分、难度、推荐方案 |
| POST | `/api/analyze/part1` | 阶段一分析，返回 `analysis` 原始 JSON + `structuredAnalysis` 规范对象 + 自然语言 |
| POST | `/api/analyze/part2` | 阶段二分析，需提供 taskId，落库并回传结构化数据 |
| POST | `/api/analyze` | combined 模式（调试用） |
| GET | `/api/analyze/:taskId` | 查询任务详情，返回 `task`（含 `feasibility_result`）以及 `structuredResult`；若库中缺失结构化结果会即时映射并返回 |
| POST | `/api/photos/upload` | 上传源/目标照片，返回 uploadId、相似度估算 |
| POST | `/api/simulate/style` | 风格模拟，基于 taskId 生成风格迁移后的图片 |
| GET | `/api/export/json?taskId=` | 导出 JSON |
| GET | `/api/export/xmp?taskId=` | 导出 Lightroom XMP |
| GET | `/api/export/jsx?taskId=` | 导出 Photoshop JSX |

#### 5.1.1 `GET /api/analyze/:taskId` 返回体（节选，新增说明）
```json
{
  "success": true,
  "task": {
    "id": "xxxx",
    "status": "part1_completed|completed",
    "feasibility_result": {
      "feasibilityScore": 0.61,
      "difficulty": "中",
      "confidence": 0.78,
      "dealBreakers": [],
      "dominantFactors": [{ "name": "色彩相似度", "reason": "色温差距明显" }],
      "recommendedActions": [{ "action": "统一白平衡", "why": "色温差距" }],
      "explanation": "总体可行（61.4%）…"
    }
  },
  "structuredResult": { /* 规范映射结果 */ }
}
```

### 5.2 规划中
| Method | Endpoint | 说明 |
|--------|----------|------|
| POST | `/api/photos/upload` | 上传源/目标照片，返回 uploadId、相似度、可选对象存储 URL |
| GET | `/api/analyze/:taskId` | 查询单个任务，输出标准结构 |
| GET | `/api/analyze/history?limit=20` | 查询最近任务列表 |
| POST | `/api/user/avatar/upload` | 上传头像（multipart） |
| GET | `/api/user/avatar/:userId` | 获取头像 |
| DELETE | `/api/user/avatar/:userId` | 删除头像 |

---

## 6. 数据模型

### 6.1 已落地：`analysis_tasks`
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(36) | UUID，任务标识 |
| source_image_data | LONGTEXT | Base64 源图 |
| target_image_data | LONGTEXT | Base64 目标图（可空） |
| gemini_result | JSON | 原始 Gemini 返回（保持完整结构） |
| structured_result | JSON | 规范映射后的 review/composition/... 汇总 |
| mapping_result | JSON | colorMapping 二次结构化结果 |
| part1_summary | LONGTEXT | Part1 自然语言摘要 |
| workflow_draft | LONGTEXT | Part1 工作流草案 |
| workflow_final | LONGTEXT | Part2 工作流成品 |
| workflow_alignment_notes | LONGTEXT | 草案 vs 执行差异 |
| natural_language_part1 | LONGTEXT | Part1 全量自然语言 |
| natural_language_part2 | LONGTEXT | Part2 全量自然语言 |
| part2_completed | TINYINT | 0/1 |
| feasibility_result | JSON | 复刻可行性评估结果（包含评分、难度、推荐方案等） |
| status | VARCHAR(20) | `pending` / `part1_completed` / `completed` / `failed` |
| created_at / updated_at | TIMESTAMP | 自动维护 |

### 6.2 已落地：`uploads`
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(64) | UUID |
| source_image_data | LONGTEXT | Base64 源图（后续替换为对象存储 URL） |
| target_image_data | LONGTEXT | Base64 目标图（可空） |
| source_image_url | TEXT | 预留对象存储 URL |
| target_image_url | TEXT | 预留对象存储 URL |
| similarity_score | DECIMAL(5,2) | 粗粒度相似度估算 |
| analysis_task_id | VARCHAR(64) | 关联任务（可空） |
| status | ENUM | `uploaded` / `linked` / `analyzed` / `expired` |
| created_at / updated_at | TIMESTAMP | 自动维护 |

### 6.3 规划中
1. `subscription_plans`
   - id、name、description、price、period、features(JSON)、is_active、sort_order、created_at、updated_at、created_by、updated_by。
2. `subscriptions`
   - id、user_id、plan_id、status（trial/active/paused/canceled/expired）、start_at、end_at、cancelled_at、renewal_order_id、metadata(JSON)、created_at、updated_at。
3. `subscription_events`
   - id、subscription_id、event_type（created/renewed/canceled/expired/changed）、payload(JSON)、created_at。
4. `payments`
   - id、order_no、user_id、plan_id、amount、currency、status（pending/succeeded/failed/refunded）、channel（alipay/wechat/stripe）、txn_id、paid_at、metadata(JSON)、created_at、updated_at。
5. `payment_refunds`（可选）
   - id、payment_id、amount、status、reason、created_at、processed_at。
6. `cms_blocks`
   - id、position（subscription/dashboard/home/...）、type（announcement/banner/feature/faq）、title、subtitle、body、media_url、cta_label、cta_link、locale、status、published_at、created_at、updated_at、created_by、updated_by。
7. `audit_logs`
   - id、admin_id、action、target_type、target_id、before(JSON)、after(JSON)、ip、user_agent、created_at。
8. `users`
   - 增加 `role ENUM('user','admin') DEFAULT 'user'`、`last_active_at`、`created_by`、`updated_by`。
9. `analysis_tasks`
   - 追加 `resource_cost JSON`、`duration_ms` 字段，便于后台统计。
10. `export_files`
    - id、task_id、type(json/xmp/jsx)、file_path/url、created_at。

---

## 7. Prompt 规范（摘要）

### 7.1 Part1 Prompt 要点
- 角色：资深摄影师 + 构图指导教师。
- 分段输出：
  1. 自然语言报告（专业点评、构图、光影、工作流草案）。
  2. JSON：`professional_evaluation`、`composition`（含 `advanced_sections` 七段）、`lighting`、`analysis_meta`、`workflow_draft`。
- 约束：
  - 禁止臆造，信息不足时标明“不确定”。
  - 构图七段使用严格标题。
  - 输出中文。

### 7.2 Part2 Prompt 要点
- 角色：摄影调色指导。
- 输入：Part1 摘要 + `workflow_draft`（JSON）+ 源/目标图。
- 输出：
  - 自然语言执行报告（含草案对齐说明）。
  - JSON：`color_scheme`、`lightroom`（全量范围）、`lightroom_local_adjustments`、`lightroom_panels`、`photoshop`（曲线/蒙版/步骤等）、`workflow_steps`、`workflow_alignment_notes`。
- 约束：
  - 所有数值需字符串形式，保留正负号；曲线点提供数组。
  - 必须说明“沿用 / 调整 / 新增”原因。
  - 若 Part1 should_stop，返回提示并终止。

---

## 8. 风格模拟功能详细说明

### 8.1 功能定位
风格模拟是新增的流程节点，基于 Part1 和 Part2 的分析结果，使用 Gemini 2.5 flash-image 生成风格迁移后的图片，让用户直观看到应用分析结果后的效果。

### 8.2 技术架构
- **模型使用**：
  - Part1 和 Part2 分析：继续使用 `gemini-2.5-pro`（不改变现有实现）
  - 风格模拟：使用 `gemini-2.5-flash-image`（新增）
- **长上下文利用**：
  - Gemini 2.5 flash-image 支持 100 万个词元的上下文窗口
  - 可以记住之前的所有交互内容，包括 Part1 和 Part2 的输出
  - 风格模拟时不需要重复上传分析结果，只需要传递 prompt 模板
- **cachedContent 机制**：
  - 固定指令模板作为 `cachedContent` 缓存（TTL: 12小时）
  - 动态部分只包含图片尺寸信息（用户图宽高比、输出分辨率）
  - 大幅减少 token 消耗

### 8.3 固定指令模板
模板要求 Gemini 调研 Part1 和 Part2 中已输出的内容：
- "照片点评"、"构图分析"、"光影参数"、"色彩方案"、"lightroom"、"photoshop"
- 提取参考图的风格特征、情感表达、视觉氛围、色调方向
- 提取色彩调整方案、光影调整方案、细节优化方案
- 明确约束：只进行如 Lightroom 和 Photoshop 的功能调整，不许增加额外元素；必须按照参考图的色调风格和调色方案调整，不许进行发散

### 8.4 图片处理
- **输入**：直接使用数据库中存储的原始图片，不进行压缩
- **输出**：根据用户图宽高比选择输出比例（1:1, 4:3, 16:9 等），分辨率建议见方案文档
- **去水印**：Gemini 生成的图片包含 SynthID 水印，使用 sharp 库进行基础去水印处理

### 8.5 前端交互
- **触发**：用户点击"风格模拟"按钮（需先完成 Part1 和 Part2 分析）
- **展示**：模态框展示前后对比效果，支持滑块拖拽、下载/分享
- **状态**：加载状态、成功展示、错误提示

### 8.6 开发优先级
1. **第一阶段**：固定指令模板确认
2. **第二阶段**：风格模拟后端 API 开发
3. **第三阶段**：前端对接
4. **第四阶段**：优化和测试

详细方案见《风格模拟功能方案-完整版.md》。

---

## 9. 关键非功能要求
- **日志**：所有 Gemini 调用必须记录耗时、阶段、缺失字段；错误保存原始返回片段（避免泄露图片数据）。
- **代理**：默认读取 `HTTPS_PROXY`，如果设置则全局覆盖 fetch。
- **安全**：上传限 25MB；未来接入对象存储时需 MIME 校验与防注入。后台管理员登录已启用密码错误锁定 + 邮箱二次验证，登录/失败写入 `login_attempts`，接口按权限细粒度控制。
- **扩展性**：设计上允许替换 LLM（Claude / GPT-4），保持 Prompt 模块化。
- **注释规范**：后端新增代码必须包含中文注释，解释用途与边界。
- **配置项**：（新增）
  - `AUTH_ADMIN_MAX_FAILED_ATTEMPTS`：管理员最大连续失败次数（默认 5）。
  - `AUTH_ADMIN_LOCK_MIN`：锁定时长（分钟，默认 15）。
  - `AUTH_ADMIN_MFA_EXPIRES_MIN`：验证码有效期（分钟，默认 10）。
  - `AUTH_ADMIN_MFA_MAX_ATTEMPTS`：验证码错误最大次数（默认 5）。

---

## 10. 迭代路线图（后端最小改动）
1. **结构化输出补强（已完成）**：完善 Prompt + 解析兜底 + 日志。
2. **查询接口（阶段一完成）**：已实现单任务查询，历史列表待上线。
3. **上传链路（已完成）**：`/api/photos/upload` + `uploads` 表（临时 Base64 + 相似度）。
4. **风格模拟功能（规划中）**：后端 API 开发、前端对接、去水印处理、优化测试。
5. **管理后台第一阶段（进行中）**：管理员鉴权、审计、Dashboard 指标、用户/订阅/支付/任务基础 API + 前端接入。
6. **管理后台第二阶段**：内容管理、数据分析高级指标、支付网关对接。
7. **用户模块**：头像上传与基础资料（若业务需要）。
8. **缓存与性能**：接入 Redis（可选），启用结果缓存、命中日志。
9. **对象存储**：将 Base64 替换为 URL、批量迁移（长期目标）。

---

## 11. 参考资料
- 《BACKEND_DEVELOPER_GUIDE.md》：上传接口、缓存、API 细节、性能优化建议。
- 《风格模拟功能方案-完整版.md》：风格模拟功能的详细设计方案、API 集成、前端对接说明。
- Gemini 官方文档：https://ai.google.dev/docs
- Gemini 长上下文文档：https://ai.google.dev/gemini-api/docs/long-context?hl=zh-cn
- Gemini 图片生成文档：https://ai.google.dev/gemini-api/docs/image-generation?hl=zh-cn
- 现有代码库：`server/src/services` / `src/lib/analysisAdapter.ts`

> 本文同步至版本控制，请后续迭代按章节更新。

---

## 13. 数据分析与支付网关预留方案

### 13.1 管理后台数据分析模块
- 后端新增 `/api/admin/analytics/metrics`，汇总以下实时指标：
  - 新增用户、活跃用户、订阅转化、支付成功率。
  - 近 14 日用户注册趋势、收入趋势、按时段拆分的任务执行量。
  - 用户登录类型分布、支付渠道表现、各订阅计划活跃/收入情况。
- 所有统计基于既有表 `users`、`analysis_tasks`、`subscriptions`、`payments`、`uploads`，避免额外埋点。
- 前端 `Analytics` 页面改为直连上述接口，组件按数据结构重绘图表，支持空数据与加载态处理。

### 13.2 支付网关对接预留
- 当前支付记录默认 `channel` 字段支持 `alipay` / `wechat` / `stripe` / `manual`，后续接入可直接落库并显示在后台。
- 预留对接步骤：
  1. 在 `payments` 表新增第三方交易号、回调状态等字段（已存在 `txn_id`、`status`、`metadata` 可扩展）。
  2. 新建 `/api/payments/create`、`/api/payments/webhook/:channel` 等路由，对应渠道 SDK 适配层集中于 `services/paymentProviders`（规划中）。
  3. 在管理后台提供支付渠道配置界面（密钥、回调地址、测试证书），并通过审计日志跟踪变更。
  4. 结合 `planPerformance` 统计输出，后续可按渠道/套餐拆分 GMV 与转化漏斗。
- 首批目标渠道：支付宝当面付 / 微信 Native / Stripe Checkout，采用同一收单服务抽象，统一签名校验与回调幂等处理。
