# 开发方案更新建议

## 📋 评估结果

**结论**：**需要更新开发方案**

## 🔍 需要更新的内容

### 1. AI 诊断 Prompt 格式和输出要求（第 167 行）

**当前开发方案**：
```
生成专业的诊断 Prompt（包含评分要求、输出格式）
```

**实际实现**：
- 角色：专业的"摄影导师"和数字策展人
- 任务：提供简明扼要的"AI 诊断卡片"
- 与 Part1/Part2 分开，只做简单的光影解读
- 诊断文本严格控制在 100 字以内
- 评分格式：支持两种格式（简单数值或带描述的格式）

**建议更新为**：
```
生成简明的诊断 Prompt（与 Part1/Part2 分开，只做简单的光影解读）：
a. 角色设定：专业的"摄影导师"和数字策展人
b. 任务：提供简明扼要的"AI 诊断卡片"
c. 输出格式：
   - 【多维评分】：曝光、色彩、构图、情感（0-10分或0-100分，支持带描述的格式）
   - 【导师诊断】：100字左右的诊断文本，用"人类语言"总结优缺点
d. 约束：语气客观、专业、鼓励性；诊断文本严格控制在 100 字以内
e. JSON 输出：支持两种评分格式（简单数值或带描述的格式）
```

### 2. 前端按钮功能（第 159-166 行）

**当前开发方案**：
- 没有明确说明在直方图和色彩雷达标签页添加"启动深度扫描"按钮

**实际实现**：
- 在直方图标签页添加"启动深度扫描"按钮
- 在色彩雷达标签页添加"启动深度扫描"按钮
- 两个按钮都切换到 AI 标签页并触发 AI 诊断

**建议添加**：
```
7. **[组件集成]** 修改 `VisualAnalysisDashboard.tsx`：
   a. 添加 `dominantColors` 状态
   b. 将 `Vectorscope` 的 `onDominantColorsExtracted` 回调连接到状态
   c. 将 `dominantColors` 传递给 `AIAnalysisPanel`
   d. 【新增】在直方图和色彩雷达标签页添加"启动深度扫描"按钮
   e. 【新增】两个按钮都切换到 AI 标签页并触发 AI 诊断
```

### 3. Schema 定义（第 168 行）

**当前开发方案**：
```
DiagnosisResponseSchema：诊断响应 Schema
```

**实际实现**：
- 支持两种评分格式：
  - 简单格式：`{"exposure": 8.5, "color": 7.2, ...}`
  - 详细格式：`{"exposure": {"value": 8.5, "description": "..."}, ...}`
- 验证逻辑支持数据标准化
- 诊断文本长度验证（100字限制）

**建议更新为**：
```
DiagnosisResponseSchema：诊断响应 Schema
a. 支持两种评分格式：
   - 简单格式：{"exposure": 8.5, "color": 7.2, ...}
   - 详细格式：{"exposure": {"value": 8.5, "description": "..."}, ...}
b. validate_diagnosis_response 函数：
   - 自动标准化评分格式（统一转换为详细格式）
   - 验证诊断文本长度（100字限制）
   - 处理数据缺失情况（使用默认值）
```

### 4. 技术要点（第 192-200 行）

**当前开发方案**：
```
- **AI 诊断**：后端实现，使用 Gemini 多模态分析，输入低分辨率图片 + 直方图数据 + 主色调列表
```

**建议更新为**：
```
- **AI 诊断**：后端实现，使用 Gemini 多模态分析，输入低分辨率图片 + 直方图数据 + 主色调列表
  - **设计定位**：与 Part1/Part2 分开，只做简单的光影解读，提供简明扼要的"AI 诊断卡片"
  - **Prompt 格式**：使用简明的 Prompt 格式，角色为"摄影导师"和数字策展人
  - **输出要求**：
    - 多维评分：曝光、色彩、构图、情感（0-10分或0-100分，支持带描述的格式）
    - 导师诊断：100字左右的诊断文本，用"人类语言"总结优缺点
  - **前端交互**：
    - 在直方图和色彩雷达标签页添加"启动深度扫描"按钮
    - 两个按钮都切换到 AI 标签页并触发 AI 诊断
    - 支持打字机效果、交互联动（点击高亮区域）、评分仪表盘
```

### 5. 注意事项（第 196-201 行）

**建议添加**：
```
- AI 诊断与 Part1/Part2 分开，只做简单的光影解读，不进行深度分析
- AI 诊断的诊断文本严格控制在 100 字以内
- AI 诊断的评分格式支持两种格式（简单数值或带描述的格式）
- 前端需要处理数据不完整的情况（使用可选链操作符和条件检查）
```

## 📝 具体更新位置

### 位置 1：第 167 行（Prompt 模板）

**更新前**：
```
1. **[Prompt 模板]** 在 `server_py/app/services/prompt_template.py` 中新增 `get_diagnosis_prompt` 方法：
   a. 接收直方图数据和主色调列表
   b. 生成专业的诊断 Prompt（包含评分要求、输出格式）
```

**更新后**：
```
1. **[Prompt 模板]** 在 `server_py/app/services/prompt_template.py` 中新增 `get_diagnosis_prompt` 方法：
   a. 接收直方图数据和主色调列表
   b. 生成简明的诊断 Prompt（与 Part1/Part2 分开，只做简单的光影解读）：
      - 角色设定：专业的"摄影导师"和数字策展人
      - 任务：提供简明扼要的"AI 诊断卡片"
      - 输出格式：
        * 【多维评分】：曝光、色彩、构图、情感（0-10分或0-100分，支持带描述的格式）
        * 【导师诊断】：100字左右的诊断文本，用"人类语言"总结优缺点
      - 约束：语气客观、专业、鼓励性；诊断文本严格控制在 100 字以内
```

### 位置 2：第 168 行（Schema 定义）

**更新前**：
```
2. **[Schema 定义]** 在 `server_py/app/schemas/analysis_schemas.py` 中新增：
   a. `DiagnosisRequestSchema`：诊断请求 Schema
   b. `DiagnosisResponseSchema`：诊断响应 Schema
   c. `validate_diagnosis_response`：响应验证函数
```

**更新后**：
```
2. **[Schema 定义]** 在 `server_py/app/schemas/analysis_schemas.py` 中新增：
   a. `DiagnosisRequestSchema`：诊断请求 Schema
   b. `DiagnosisResponseSchema`：诊断响应 Schema（支持两种评分格式：简单数值或带描述的格式）
   c. `validate_diagnosis_response`：响应验证函数
      - 自动标准化评分格式（统一转换为详细格式）
      - 验证诊断文本长度（100字限制）
      - 处理数据缺失情况（使用默认值）
```

### 位置 3：第 165 行（组件集成）

**更新前**：
```
7. **[组件集成]** 修改 `VisualAnalysisDashboard.tsx`：
   a. 添加 `dominantColors` 状态
   b. 将 `Vectorscope` 的 `onDominantColorsExtracted` 回调连接到状态
   c. 将 `dominantColors` 传递给 `AIAnalysisPanel`
```

**更新后**：
```
7. **[组件集成]** 修改 `VisualAnalysisDashboard.tsx`：
   a. 添加 `dominantColors` 状态
   b. 将 `Vectorscope` 的 `onDominantColorsExtracted` 回调连接到状态
   c. 将 `dominantColors` 传递给 `AIAnalysisPanel`
   d. 【新增】在直方图和色彩雷达标签页添加"启动深度扫描"按钮
   e. 【新增】两个按钮都切换到 AI 标签页并触发 AI 诊断
```

### 位置 4：第 192 行（技术要点）

**更新前**：
```
- **AI 诊断**：后端实现，使用 Gemini 多模态分析，输入低分辨率图片 + 直方图数据 + 主色调列表
```

**更新后**：
```
- **AI 诊断**：后端实现，使用 Gemini 多模态分析，输入低分辨率图片 + 直方图数据 + 主色调列表
  - **设计定位**：与 Part1/Part2 分开，只做简单的光影解读，提供简明扼要的"AI 诊断卡片"
  - **Prompt 格式**：使用简明的 Prompt 格式，角色为"摄影导师"和数字策展人
  - **输出要求**：
    * 多维评分：曝光、色彩、构图、情感（0-10分或0-100分，支持带描述的格式）
    * 导师诊断：100字左右的诊断文本，用"人类语言"总结优缺点
  - **前端交互**：
    * 在直方图和色彩雷达标签页添加"启动深度扫描"按钮
    * 两个按钮都切换到 AI 标签页并触发 AI 诊断
    * 支持打字机效果、交互联动（点击高亮区域）、评分仪表盘
```

### 位置 5：第 196-201 行（注意事项）

**更新前**：
```
**注意事项**：
- 色彩雷达遵循开发方案原则（前端计算，与直方图一致）
- 色彩雷达是前端实时计算，不使用硬编码模拟数据
- AI 诊断使用低分辨率图片（512x512）以降低 API 成本
- 诊断结果可以缓存（相同图片 + 相同数据）
- 确保不影响现有 Part1/Part2 分析流程
```

**更新后**：
```
**注意事项**：
- 色彩雷达遵循开发方案原则（前端计算，与直方图一致）
- 色彩雷达是前端实时计算，不使用硬编码模拟数据
- AI 诊断使用低分辨率图片（512x512）以降低 API 成本
- 诊断结果可以缓存（相同图片 + 相同数据）
- 确保不影响现有 Part1/Part2 分析流程
- 【新增】AI 诊断与 Part1/Part2 分开，只做简单的光影解读，不进行深度分析
- 【新增】AI 诊断的诊断文本严格控制在 100 字以内
- 【新增】AI 诊断的评分格式支持两种格式（简单数值或带描述的格式）
- 【新增】前端需要处理数据不完整的情况（使用可选链操作符和条件检查）
```

## ✅ 更新优先级

1. **高优先级**：
   - Prompt 格式和输出要求（第 167 行）
   - 前端按钮功能（第 165 行）
   - 技术要点（第 192 行）

2. **中优先级**：
   - Schema 定义（第 168 行）
   - 注意事项（第 196-201 行）

## 📄 更新后的好处

1. **文档完整性**：开发方案与实际实现保持一致
2. **可维护性**：后续开发人员可以清楚了解 AI 诊断的设计定位
3. **可追溯性**：明确记录功能变更和设计决策
4. **避免混淆**：明确说明 AI 诊断与 Part1/Part2 的区别

---

**评估时间**：2025-01-24  
**评估结论**：需要更新开发方案，主要更新 AI 诊断的 Prompt 格式、输出要求、前端按钮功能和 Schema 定义

